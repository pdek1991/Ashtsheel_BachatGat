<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अष्टशील महिला बचत गट</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
            border: none;
        }
        .btn-secondary {
            background-color: #007bff;
            color: white;
            border: none;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
            border: none;
        }
        .flash-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: white;
        }
        .flash-success {
            background-color: #28a745;
        }
        .flash-danger {
            background-color: #dc3545;
        }
        .flash-info {
            background-color: #17a2b8;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Table styles for user summary */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .user-table th, .user-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .user-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .user-table tr:hover {
            background-color: #f1f1f1;
        }
        .status-received {
            color: green;
            font-weight: bold;
        }
        .status-pending {
            color: red;
            font-weight: bold;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .report-widget {
            background-color: #e6f7ff; /* Light blue */
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .report-widget.profit {
            background-color: #d4edda; /* Light green for profit */
            border-color: #28a745;
        }
         .report-widget.loan {
            background-color: #f8d7da; /* Light red for loan/pending */
            border-color: #dc3545;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #e2e8f0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
        }
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 2px solid #4CAF50;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .table-container {
            overflow-x: auto;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .transaction-table th, .transaction-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            white-space: nowrap; /* Prevent wrapping for better readability of data */
        }
        .transaction-table th {
            background-color: #f2f2f2;
            font-weight: 600;
            color: #555;
        }
        .transaction-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .transaction-table tbody tr:hover {
            background-color: #f1f1f1;
        }
        .status-paid {
            color: green;
            font-weight: bold;
        }
        .status-pending {
            color: orange;
            font-weight: bold;
        }
        .status-not-applicable {
            color: gray;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="header flex justify-between items-center">
            <h1 class="text-3xl font-bold" id="app-name-header"></h1>
            <div id="auth-status" class="text-white text-lg font-medium"></div>
            <button id="logout-btn" class="btn btn-danger hidden">Logout</button>
        </header>

        <div id="flash-messages" class="messages mb-4"></div>

        <div id="loginModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <p class="text-sm text-gray-600 mt-4">Admin: admin/admin | Guest: guest/guest</p>
            </div>
        </div>

        <div id="app-content" style="display: none;">
            <div class="card mb-6" id="group-selection-card">
                <h2 class="text-xl font-semibold mb-4" id="select-group-heading"></h2>
                <div class="mb-4 flex items-center space-x-4">
                    <select name="group_id" id="groupSelect" class="form-control flex-grow border rounded p-2"></select>
                    <button type="button" class="btn btn-primary" onclick="openModal('addGroupModal')" id="add-group-btn"></button>
                </div>
                <button type="button" class="btn btn-secondary mt-2 inline-block" onclick="showAllGroupsReport()" id="view-all-groups-report-btn"></button>
            </div>

            <div id="dashboard-content" style="display: none;">
                <div class="card mb-6">
                    <h2 class="text-2xl font-bold mb-4" id="group-financial-summary-heading"></h2>
                    <div class="report-grid" id="group-summary-reports">
                        </div>
                </div>

                <div class="card mb-6">
                    <h2 class="text-2xl font-bold mb-4" id="users-and-loans-summary-heading"></h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <button type="button" class="btn btn-primary" onclick="openModal('addUserModal')" id="add-new-user-btn"></button>
                        <button type="button" class="btn btn-primary" onclick="openModal('addContributionModal')" id="add-contribution-btn"></button>
                        <button type="button" class="btn btn-primary" onclick="openModal('addLoanModal')" id="add-new-loan-btn"></button>
                        <button type="button" class="btn btn-secondary" onclick="downloadUsersCsv()" id="download-users-csv-btn"></button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="user-table w-full text-sm">
                            <thead>
                                <tr>
                                    <th id="user-name-th"></th>
                                    <th id="monthly-contribution-status-th"></th>
                                    <th id="total-contribution-by-user-th"></th>
                                    <th id="pending-contribution-by-user-th"></th>
                                    <th id="pending-loan-amount-with-interest-th"></th>
                                    <th id="total-amount-paid-by-user-till-date-th"></th>
                                    <th id="loan-details-th"></th>
                                    <th id="actions-th"></th>
                                </tr>
                            </thead>
                            <tbody id="users-data-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="card mb-6" id="csv-bulk-uploads-section">
                    <h2 class="text-xl font-semibold mb-4" id="csv-bulk-uploads-heading">CSV Bulk Uploads</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2" id="bulk-upload-transactions-heading"></h3>
                        <form id="bulk-upload-transactions-form" class="space-y-4">
                            <label for="transaction_csv" class="block text-sm font-medium text-gray-700" id="choose-csv-file-transactions-label"></label>
                            <input type="file" name="file" id="transaction_csv" accept=".csv" class="form-control">
                            <button type="submit" class="btn btn-primary" id="upload-transactions-btn"></button>
                            <button type="button" class="btn btn-info" onclick="downloadSampleTransactionsCsv()" id="download-sample-transactions-btn"></button>
                        </form>
                    </div>

                    <div>
                        <h3 class="text-lg font-medium mb-2" id="bulk-upload-users-heading"></h3>
                        <form id="bulk-upload-users-form" class="space-y-4">
                            <label for="user_csv" class="block text-sm font-medium text-gray-700" id="choose-csv-file-users-label"></label>
                            <input type="file" name="file" id="user_csv" accept=".csv" class="form-control">
                            <button type="submit" class="btn btn-primary" id="upload-users-btn"></button>
                            <button type="button" class="btn btn-info" onclick="downloadSampleUsersCsv()" id="download-sample-users-btn"></button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="all-groups-report-content" style="display: none;">
                <div class="mb-4">
                    <button type="button" class="btn btn-secondary" onclick="showDashboard()" id="back-to-dashboard-btn-report"></button>
                </div>
                <div id="all-groups-report-cards">
                    </div>
            </div>

            <div id="view-transactions-content" style="display: none;">
                <header class="header">
                    <h1 class="text-3xl font-bold" id="view-transactions-header"></h1>
                    <h2 class="text-xl mt-2" id="view-transactions-user-name"></h2>
                </header>
                <div class="mb-6">
                    <button type="button" class="btn btn-secondary" onclick="showDashboard()" id="back-to-dashboard-btn-transactions"></button>
                </div>

                <div class="card mb-6">
                    <h3 class="text-xl font-semibold mb-4" id="filter-transactions-heading"></h3>
                    <form id="filter-transactions-form" class="flex flex-wrap items-end space-x-4">
                        <input type="hidden" id="filter-user-id">
                        <div class="form-group">
                            <label for="filter-from-date" class="block text-sm font-medium text-gray-700" id="from-date-label"></label>
                            <input type="date" id="filter-from-date" name="from_date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="filter-to-date" class="block text-sm font-medium text-gray-700" id="to-date-label"></label>
                            <input type="date" id="filter-to-date" name="to_date" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary" id="apply-filter-btn"></button>
                        <button type="button" class="btn btn-secondary" onclick="clearTransactionFilter()" id="clear-filter-btn"></button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4" id="transaction-history-heading"></h3>
                    <div class="table-container">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th id="date-th"></th>
                                    <th id="type-th"></th>
                                    <th id="amount-th"></th>
                                    <th id="is-cash-payment-th"></th>
                                    <th id="is-paid-th"></th>
                                    <th id="loan-id-th"></th>
                                    <th id="new-loan-interest-rate-th"></th>
                                    <th id="description-th"></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-data-tbody">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-transactions-found" class="text-gray-600 mt-4" style="display: none;"></div>
                    <button type="button" class="btn btn-secondary mt-4" onclick="downloadTransactionsCsv()" id="download-transactions-csv-btn"></button>
                </div>
            </div>
        </div>


    </div>

    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addGroupModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-group-modal-heading"></h2>
            <form id="add-group-form" class="space-y-4">
                <div class="form-group">
                    <label for="group_name" id="group-name-label"></label>
                    <input type="text" id="group_name" name="group_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="bank_account_details" id="bank-account-details-label"></label>
                    <textarea id="bank_account_details" name="bank_account_details" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label for="default_interest_rate" id="default-interest-rate-label"></label>
                    <input type="number" step="0.01" id="default_interest_rate" name="default_interest_rate" class="form-control" value="12.0" required>
                </div>
                <div class="form-group">
                    <label for="bank_interest_rate" id="bank-interest-rate-label"></label>
                    <input type="number" step="0.01" id="bank_interest_rate" name="bank_interest_rate" class="form-control" value="3.0" required>
                </div>
                <button type="submit" class="btn btn-primary" id="add-group-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="updateBankRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('updateBankRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="edit-bank-interest-rate-modal-heading"></h2>
            <form id="update-bank-rate-form" class="space-y-4">
                <div class="form-group">
                    <label for="new_bank_interest_rate" id="new-interest-rate-label"></label>
                    <input type="number" step="0.01" id="new_bank_interest_rate" name="new_bank_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="update-bank-rate-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addUserModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-new-user-modal-heading"></h2>
            <form id="add-user-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_name_input" id="user-name-input-label"></label>
                    <input type="text" id="user_name_input" name="user_name" class="form-control" required>
                </div>
                <div class="form-group flex items-center space-x-2">
                    <input type="checkbox" id="is_admin" name="is_admin" class="form-checkbox h-4 w-4 text-green-600">
                    <label for="is_admin" class="text-gray-700" id="is-admin-label"></label>
                </div>
                <button type="submit" class="btn btn-primary" id="add-user-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addContributionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addContributionModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-contribution-modal-heading"></h2>
            <form id="add-contribution-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_id_contribution" id="user-name-contribution-label"></label>
                    <select id="user_id_contribution" name="user_id" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="amount_contribution" id="amount-label-contribution"></label>
                    <input type="number" step="0.01" id="amount_contribution" name="amount" class="form-control" required>
                </div>
                <div class="form-group flex items-center space-x-2">
                    <input type="checkbox" id="is_cash_payment_contribution" name="is_cash_payment" class="form-checkbox h-4 w-4 text-green-600">
                    <label for="is_cash_payment_contribution" class="text-gray-700" id="is-cash-payment-label-contribution"></label>
                </div>
                <button type="submit" class="btn btn-primary" id="add-contribution-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="markPaidModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('markPaidModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="mark-paid-modal-heading"></h2>
            <form id="markPaidForm" class="space-y-4">
                <input type="hidden" id="mark-paid-transaction-id">
                <p id="mark-paid-confirmation-text"></p>
                <button type="submit" class="btn btn-primary" id="mark-paid-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addLoanModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-new-loan-modal-heading"></h2>
            <form id="add-loan-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_id_loan" id="user-name-loan-label"></label>
                    <select id="user_id_loan" name="user_id" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="loan_amount" id="loan-amount-label"></label>
                    <input type="number" step="0.01" id="loan_amount" name="loan_amount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loan_issue_date" id="loan-issue-date-label"></label>
                    <input type="date" id="loan_issue_date" name="loan_issue_date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loan_interest_rate" id="loan-interest-rate-label"></label>
                    <input type="number" step="0.01" id="loan_interest_rate" name="loan_interest_rate" class="form-control" value="12.0" required>
                </div>
                <button type="submit" class="btn btn-primary" id="add-loan-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="repayLoanModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('repayLoanModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="repay-loan-modal-heading"></h2>
            <form id="repay-loan-form" class="space-y-4">
                <input type="hidden" id="repay_loan_id">
                <p><b id="loan-id-display-label"></b> <span id="display_repay_loan_id"></span></p>
                <p><b id="outstanding-balance-display-label"></b> ₹<span id="display_outstanding_balance"></span></p>
                <p><b id="current-interest-rate-display-label"></b> <span id="display_current_interest_rate"></span>%</p>
                <p><b id="last-interest-calc-date-display-label"></b> <span id="display_last_interest_calc_date"></span></p>
                
                <div class="form-group">
                    <label for="repayment_amount" id="repayment-amount-label"></label>
                    <input type="number" step="0.01" id="repayment_amount" name="repayment_amount" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="repay-loan-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="changeInterestRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('changeInterestRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="change-interest-rate-modal-heading"></h2>
            <form id="change-interest-rate-form" class="space-y-4">
                <input type="hidden" id="change_rate_loan_id">
                <p><b id="loan-id-change-rate-label"></b> <span id="display_change_rate_loan_id"></span></p>
                <p><b id="current-rate-change-rate-label"></b> <span id="display_old_interest_rate"></span>%</p>
                <div class="form-group">
                    <label for="new_interest_rate_input" id="new-interest-rate-input-label"></label>
                    <input type="number" step="0.01" id="new_interest_rate_input" name="new_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="change-interest-rate-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="updateBankRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('updateBankRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="edit-bank-interest-rate-modal-heading-2"></h2>
            <form id="update-bank-rate-form-2" class="space-y-4">
                <div class="form-group">
                    <label for="new_bank_interest_rate_input_2" id="new-interest-rate-label-2"></label>
                    <input type="number" step="0.01" id="new_bank_interest_rate_input_2" name="new_bank_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="update-bank-rate-submit-btn-2"></button>
            </form>
        </div>
    </div>


    <script>
        // --- GitHub Data Store Configuration ---
        const GITHUB_OWNER = 'pdek1991';
        const GITHUB_REPO = 'Ashtsheel_BachatGat';
        const GITHUB_DATA_BRANCH = 'data'; // The branch where your data files are stored
        const GITHUB_API_BASE_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/`;

        // !!! SECURITY WARNING: DO NOT USE THIS IN PRODUCTION !!!
        // This token will be publicly visible. For testing purposes only.
        // Replace 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN' with your actual GitHub PAT.
        const GITHUB_TOKEN = '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';

        let currentUserRole = null; // 'admin' or 'guest'

        // In-memory cache for data to reduce GitHub API calls
        let groupData = [];
        let userData = [];
        let transactionData = [];
        let loanData = [];

        const MARATHI_LABELS = {
            'app_name': 'अष्टशील महिला बचत गट',
            'select_group': 'गट निवडा',
            'add_group': 'नवीन गट जोडा',
            'group_name': 'गटाचे नाव',
            'bank_account_details': 'बँक खात्याचा तपशील',
            'default_interest_rate': 'कर्जावरील पूर्वनिर्धारित व्याज दर (%)',
            'add': 'जोडा',
            'group_financial_summary': 'गटाचा आर्थिक सारांश',
            'overall_summary': 'एकूण नफा',
            'total_contributions': 'एकूण योगदान',
            'total_loans_disbursed': 'वितरित एकूण कर्ज',
            'total_loan_repayments': 'एकूण कर्ज परतफेड',
            'total_interest_received': 'मिळालेले एकूण व्याज',
            'overall_profit': 'एकूण नफा',
            'monthly_profit': 'मासिक नफा (या महिन्याचा)',
            'yearly_profit': 'वार्षिक नफा (या वर्षाचा)',
            'monthly_investment': 'मासिक गुंतवणूक (या महिन्याची)',
            'yearly_investment': 'वार्षिक गुंतवणूक (या वर्षाची)',
            'group_profit_label': 'गट नफा',
            'users_and_loans_summary': 'सदस्य आणि कर्जाचा सारांश',
            'user_name': 'सदस्य नाव',
            'loan_amount_outstanding': 'थकबाकी कर्ज रक्कम',
            'interest_paid': 'व्याज भरले',
            'remaining_loan_amount_with_interest': 'व्याजसह उर्वरित कर्ज रक्कम',
            'monthly_contribution_status': 'मासिक योगदान स्थिती',
            'active': 'सक्रिय',
            'inactive': 'निष्क्रिय',
            'add_new_user': 'नवीन सदस्य जोडा',
            'user_name_input': 'सदस्य नाव',
            'is_admin': 'प्रशासक आहे का?',
            'toggle_status': 'स्थिती बदला',
            'add_contribution': 'योगदान जोडा',
            'amount': 'रक्कम',
            'is_cash_payment': 'रोख भरणा आहे का?',
            'mark_paid': 'भरणा झाला म्हणून चिन्हांकित करा',
            'add_new_loan': 'नवीन कर्ज जोडा',
            'loan_amount': 'कर्ज रक्कम',
            'loan_issue_date': 'कर्ज दिल्याची तारीख',
            'loan_interest_rate': 'कर्जावरील व्याज दर (%)',
            'repay_loan': 'कर्ज परतफेड करा',
            'repayment_amount': 'परतफेड रक्कम',
            'change_interest_rate': 'व्याज दर बदला',
            'new_interest_rate': 'नवीन व्याज दर (%)',
            'loan_id': 'कर्ज आयडी',
            'status_active': 'सक्रिय',
            'status_paid_off': 'कर्ज फेडले',
            'status_pending_cash_payment': 'रोख भरणा बाकी',
            'bulk_upload_transactions': 'बल्क व्यवहार अपलोड करा',
            'bulk_upload_users': 'बल्क सदस्य अपलोड करा',
            'download_sample_transactions': 'व्यवहार नमुना CSV डाउनलोड करा',
            'download_sample_users': 'सदस्य नमुना CSV डाउनलोड करा',
            'choose_csv_file': 'CSV फाइल निवडा',
            'upload': 'अपलोड करा',
            'no_file_part': 'फाइलचा भाग नाही',
            'no_selected_file': 'कोणतीही फाइल निवडली नाही',
            'invalid_file_type': 'चुकीचा फाइल प्रकार. कृपया CSV फाइल अपलोड करा.',
            'upload_complete': 'बल्क अपलोड पूर्ण झाले. {processed_count} व्यवहार यशस्वीरित्या प्रक्रिया केले, {error_count} त्रुटी.',
            'upload_error': 'बल्क अपलोड दरम्यान त्रुटी: {error}',
            'user_not_found_in_group': "गट '{group_name}' मध्ये सदस्य '{user_name}' सापडला नाही.",
            'unknown_transaction_type': "अज्ञात व्यवहार प्रकार '{transaction_type}'",
            'data_conversion_error': "डेटा रूपांतरण त्रुटी: {error}",
            'error_processing_row': "पंक्ती प्रक्रिया करताना त्रुटी: {error}",
            'loan_id_missing': "कर्ज परतफेडीसाठी 'loan_id' आवश्यक आहे.",
            'loan_not_found': "कर्ज आयडी {loan_id} या सदस्यासाठी या गटात सापडला नाही.",
            'loan_already_paid_off': "हे कर्ज आधीच फेडले गेले आहे.",
            'loan_id_not_for_new_loan': "'loan_disbursement' साठी 'loan_id' देऊ नये.",
            'invalid_interest_rate': "नवीन कर्जासाठी व्याज दर '{rate}' अवैध आहे. तो 0 आणि 100 च्या दरम्यान असावा.",
            'group_added_success': 'गट यशस्वीरित्या जोडला!',
            'group_exists_error': 'त्रुटी: या नावाने गट आधीच अस्तित्वात आहे.',
            'interest_rate_number_error': 'त्रुटी: पूर्वनिर्धारित व्याज दर एक संख्या असणे आवश्यक आहे.',
            'error_adding_group': 'गट जोडताना त्रुटी: {error}',
            'user_added_success': 'सदस्य "{name}" यशस्वीरित्या जोडला!',
            'error_adding_user': 'सदस्य जोडताना त्रुटी: {error}',
            'unauthorized_access': 'अनधिकृत प्रवेश.', // Not directly applicable in client-side, but kept for consistency
            'user_status_changed': 'सदस्य स्थिती "{status}" मध्ये बदलली.',
            'user_not_found': 'सदस्य सापडला नाही.',
            'contribution_added_success': '₹{amount:.2f} चे योगदान {user_name} साठी जोडले. स्थिती: {status}.',
            'pending_cash_payment': 'रोख भरणा बाकी',
            'paid_upi_bank': 'भरले (UPI/बँक)',
            'error_adding_contribution': 'योगदान जोडताना त्रुटी: {error}',
            'cash_payment_marked_paid': 'रोख भरणा भरले म्हणून चिन्हांकित केला.',
            'payment_already_paid': 'भरणा आधीच भरले म्हणून चिन्हांकित केला आहे.',
            'transaction_not_found': 'व्यवहार सापडला नाही किंवा प्रलंबित रोख भरणा नाही.',
            'invalid_user_or_group': 'अवैध सदस्य आयडी किंवा सदस्य निर्दिष्ट गटाशी संबंधित नाही.',
            'invalid_group_id': 'अवैध गट आयडी.',
            'loan_amount_positive_error': 'कर्ज रक्कम सकारात्मक असणे आवश्यक आहे.',
            'loan_date_invalid': 'कर्ज दिल्याची तारीख भविष्यातील असू शकत नाही.',
            'loan_added_success': 'कर्ज यशस्वीरित्या जोडले!',
            'error_adding_loan': 'कर्ज जोडताना त्रुटी: {error}',
            'repayment_amount_positive_error': 'परतफेड रक्कम सकारात्मक असणे आवश्यक आहे.',
            'repayment_amount_exceeds_loan': 'परतफेड रक्कम कर्जाच्या थकबाकीपेक्षा जास्त असू शकत नाही.',
            'loan_repaid_success': 'कर्ज यशस्वीरित्या परतफेड केले!',
            'error_repaying_loan': 'कर्ज परतफेड करताना त्रुटी: {error}',
            'interest_rate_positive_error': 'व्याज दर 0 पेक्षा जास्त असावा.',
            'interest_rate_change_success': 'व्याज दर यशस्वीरित्या बदलला!',
            'error_changing_interest_rate': 'व्याज दर बदलताना त्रुटी: {error}',
            'bank_interest_rate_label': 'बँक व्याज दर (%)',
            'update_bank_rate_success': 'बँक व्याज दर यशस्वीरित्या अद्यतनित केला!',
            'error_updating_bank_rate': 'बँक व्याज दर अद्यतनित करताना त्रुटी: {error}',
            'view_all_groups_report': 'सर्व गटांचा अहवाल पहा',
            'back_to_dashboard': 'डॅशबोर्डवर परत जा',
            'overall_financial_summary_all_groups': 'सर्व गटांचा एकूण आर्थिक सारांश',
            'total_profit_all_groups': 'सर्व गटांचा एकूण नफा',
            'total_invested_all_groups': 'सर्व गटांमध्ये एकूण गुंतवणूक',
            'total_loan_given_all_groups': 'सर्व गटांमध्ये एकूण कर्ज वाटप',
            'total_loan_repaid_all_groups': 'सर्व गटांमध्ये एकूण कर्ज परतफेड',
            'group_not_found': "गट '{group_identifier}' सापडला नाही.",
            'download_users_csv': 'सदस्य CSV डाउनलोड करा',
            'view_transactions': 'व्यवहार पहा',
            'date': 'तारीख',
            'type': 'प्रकार',
            'amount': 'रक्कम',
            'is_cash_payment_th': 'रोख भरणा',
            'is_paid_th': 'भरणा झाला',
            'loan_id_th': 'कर्ज आयडी',
            'new_loan_interest_rate_th': 'नवीन कर्ज व्याज दर',
            'description_th': 'तपशील',
            'filter_transactions': 'व्यवहार फिल्टर करा',
            'from_date': 'पासूनची तारीख',
            'to_date': 'पर्यंतची तारीख',
            'apply_filter': 'फिल्टर लागू करा',
            'clear_filter': 'फिल्टर साफ करा',
            'transaction_history': 'व्यवहार इतिहास',
            'no_transactions_found': 'कोणतेही व्यवहार सापडले नाहीत.',
            'download_transactions_csv': 'व्यवहार CSV डाउनलोड करा',
            'user_transaction_history_for': '{user_name} साठी व्यवहार इतिहास',
            'edit_bank_interest_rate': 'बँक व्याज दर संपादित करा',
            'new_interest_rate_label': 'नवीन बँक व्याज दर (%)',
            'update': 'अद्यतनित करा',
            'mark_paid_confirmation': 'तुम्हाला हा व्यवहार भरला म्हणून चिन्हांकित करायचा आहे का?',
            'mark_paid_modal_heading': 'भरला म्हणून चिन्हांकित करा',
            'mark_paid_submit_btn': 'होय, चिन्हांकित करा',
            'add_new_user_modal_heading': 'नवीन सदस्य जोडा',
            'add_contribution_modal_heading': 'योगदान जोडा',
            'amount_label_contribution': 'रक्कम',
            'is_cash_payment_label_contribution': 'रोख भरणा आहे का?',
            'add_contribution_submit_btn': 'योगदान जोडा',
            'add_new_loan_modal_heading': 'नवीन कर्ज जोडा',
            'loan_amount_label': 'कर्ज रक्कम',
            'loan_issue_date_label': 'कर्ज दिल्याची तारीख',
            'loan_interest_rate_label': 'कर्जावरील व्याज दर (%)',
            'add_loan_submit_btn': 'कर्ज जोडा',
            'repay_loan_modal_heading': 'कर्ज परतफेड करा',
            'loan_id_display_label': 'कर्ज आयडी:',
            'outstanding_balance_display_label': 'थकबाकी:',
            'current_interest_rate_display_label': 'सध्याचा व्याज दर:',
            'last_interest_calc_date_display_label': 'शेवटची व्याज गणना तारीख:',
            'repayment_amount_label': 'परतफेड रक्कम',
            'repay_loan_submit_btn': 'परतफेड करा',
            'change_interest_rate_modal_heading': 'व्याज दर बदला',
            'loan_id_change_rate_label': 'कर्ज आयडी:',
            'current_rate_change_rate_label': 'सध्याचा दर:',
            'new_interest_rate_input_label': 'नवीन व्याज दर (%)',
            'change_interest_rate_submit_btn': 'व्याज दर बदला',
            'choose_csv_file_transactions_label': 'व्यवहारांसाठी CSV फाइल निवडा',
            'upload_transactions_btn': 'व्यवहार अपलोड करा',
            'download_sample_transactions_btn': 'नमुना व्यवहार CSV डाउनलोड करा',
            'bulk_upload_transactions_heading': 'बल्क व्यवहार अपलोड करा',
            'choose_csv_file_users_label': 'सदस्यांसाठी CSV फाइल निवडा',
            'upload_users_btn': 'सदस्य अपलोड करा',
            'download_sample_users_btn': 'नमुना सदस्य CSV डाउनलोड करा',
            'bulk_upload_users_heading': 'बल्क सदस्य अपलोड करा',
            'csv_bulk_uploads_heading': 'CSV बल्क अपलोड',
            'error_fetching_data': 'डेटा मिळवताना त्रुटी: {data_type}: {error}',
            'error_fetching_groups': 'गट मिळवताना त्रुटी: {error}'
        };

        function getMarathiLabel(key, replacements = {}) {
            let label = MARATHI_LABELS[key] || key;
            for (const placeholder in replacements) {
                label = label.replace(new RegExp(`{${placeholder}}`, 'g'), replacements[placeholder]);
            }
            return label;
        }

        function flashMessage(message, type) {
            const messagesDiv = document.getElementById('flash-messages');
            const msgElement = document.createElement('div');
            msgElement.className = `flash-message flash-${type}`;
            msgElement.textContent = message;
            messagesDiv.appendChild(msgElement);

            setTimeout(() => {
                msgElement.remove();
            }, 5000); // Message disappears after 5 seconds
        }

        async function _fetchGitHubFile(filePath, method = 'GET', content = null, sha = null) {
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}?ref=${GITHUB_DATA_BRANCH}`;
            const headers = {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
            };

            const body = {
                message: `Update ${filePath}`,
                branch: GITHUB_DATA_BRANCH,
            };

            if (content) {
                // For PUT operations, content needs to be stringified and then Base64 encoded
                body.content = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
            }

            if (sha) {
                body.sha = sha;
            }

            const options = {
                method: method,
                headers: headers,
            };

            if (method === 'PUT' || method === 'DELETE') { // DELETE also needs a body in GitHub API
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`GitHub API Error (${response.status} - ${response.statusText}): ${errorText}`);
                    // Throw a specific error for handling in calling functions
                    throw new Error(`Failed to fetch/update GitHub file: ${response.status} ${response.statusText} - ${errorText}`);
                }
                if (method === 'GET') {
                    // For GET, return the JSON response which contains content and sha
                    return await response.json();
                } else {
                    // For PUT/DELETE, it usually returns the updated file metadata
                    return await response.json(); 
                }
            } catch (error) {
                console.error(`_fetchGitHubFile: Error fetching/updating ${filePath}:`, error);
                throw error; // Re-throw to propagate to calling functions
            }
        }

        async function addData(dataType, newData) {
            // FIX 1: Correct file path - remove 'data/' prefix if files are directly in 'data' branch root
            const filePath = `${dataType}.json`; // Corrected path
            let currentData = [];
            let fileSha = null;

            try {
                const githubFileResponse = await _fetchGitHubFile(filePath, 'GET');

                // FIX 2: Check if content exists before decoding and parsing
                if (githubFileResponse && githubFileResponse.content) {
                    const base64Content = githubFileResponse.content;
                    fileSha = githubFileResponse.sha;

                    try {
                        const decodedContent = atob(base64Content); // Handles InvalidCharacterError
                        // FIX 3: Robust JSON parsing
                        const parsedContent = JSON.parse(decodedContent); // Handles SyntaxError: Unexpected end of JSON input

                        // FIX 4: Ensure currentData is always an array
                        if (Array.isArray(parsedContent)) {
                            currentData = parsedContent;
                        } else {
                            console.warn(`Warning: ${filePath} content is not a valid JSON array. Initializing with empty array.`, parsedContent);
                            currentData = [];
                        }
                    } catch (decodeParseError) {
                        // Catch errors from atob or JSON.parse
                        console.error(`Error decoding or parsing content for ${filePath}:`, decodeParseError);
                        console.warn(`Assuming ${filePath} is empty or malformed. Initializing with empty array.`);
                        currentData = [];
                    }
                } else {
                    // If no content received (e.g., new file or 404 gracefully handled by _fetchGitHubFile)
                    console.warn(`No content received for ${filePath}. Initializing with empty array.`);
                    currentData = [];
                }
            } catch (error) {
                // FIX 5: Gracefully handle file not found or other fetch errors
                if (error.message.includes('404')) {
                    console.warn(`File ${filePath} not found. Initializing with empty array for new data.`);
                    currentData = [];
                } else {
                    console.error(`Error fetching existing data for ${dataType}.json:`, error);
                    flashMessage(getMarathiLabel('error_fetching_groups', { error: error.message }), 'danger');
                    return false;
                }
            }

            currentData.push(newData);

            try {
                const updatedContentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(currentData))));
                await _fetchGitHubFile(filePath, 'PUT', currentData, fileSha);
                console.log(`Successfully added data to ${dataType}.json`);
                return true;
            } catch (error) {
                console.error(`Error saving data to ${dataType}.json:`, error);
                flashMessage(getMarathiLabel('error_adding_group', { error: error.message }), 'danger');
                return false;
            }
        }

        async function getAllData(dataType) {
            // FIX 1: Correct file path - remove 'data/' prefix
            const filePath = `${dataType}.json`; // Corrected path
            try {
                const githubFileResponse = await _fetchGitHubFile(filePath, 'GET');

                // FIX 2: Check if content exists before decoding and parsing
                if (githubFileResponse && githubFileResponse.content) {
                    const base64Content = githubFileResponse.content;
                    try {
                        const decodedContent = atob(base64Content); // Handles InvalidCharacterError
                        // FIX 3: Robust JSON parsing
                        const parsedContent = JSON.parse(decodedContent); // Handles SyntaxError: Unexpected end of JSON input

                        // FIX 4: Ensure returned data is always an array
                        if (Array.isArray(parsedContent)) {
                            return parsedContent;
                        } else {
                            console.warn(`Warning: ${filePath} content is not a valid JSON array. Returning empty array.`, parsedContent);
                            return [];
                        }
                    } catch (decodeParseError) {
                        // Catch errors from atob or JSON.parse
                        console.error(`Error decoding or parsing content for ${filePath}:`, decodeParseError);
                        console.warn(`Assuming ${filePath} is empty or malformed. Returning empty array.`);
                        return [];
                    }
                } else {
                    // If no content received (e.g., new file or 404 gracefully handled by _fetchGitHubFile)
                    console.warn(`No content received for ${filePath}. Returning empty array.`);
                    return [];
                }
            } catch (error) {
                // FIX 5: Gracefully handle file not found or other fetch errors
                if (error.message.includes('404')) {
                    console.warn(`File ${filePath} not found. Returning empty array.`);
                    return [];
                } else {
                    console.error(`Error fetching all ${dataType} data:`, error);
                    flashMessage(getMarathiLabel('error_fetching_data', { data_type: dataType, error: error.message }), 'danger');
                    return [];
                }
            }
        }

        // --- Authentication Functions ---
        async function login(username, password) {
            // Simplified authentication for client-side demo
            // In a real application, you would send these credentials to a secure backend for verification.
            if (username === 'admin' && password === 'admin') {
                currentUserRole = 'admin';
                flashMessage('प्रशासक म्हणून लॉग इन यशस्वी!', 'success');
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('auth-status').textContent = 'प्रशासक';
                document.getElementById('logout-btn').classList.remove('hidden');
                await loadGroupSelect(); // Load groups after successful login
                showDashboard();
                return true;
            } else if (username === 'guest' && password === 'guest') {
                currentUserRole = 'guest';
                flashMessage('अतिथी म्हणून लॉग इन यशस्वी!', 'success');
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('auth-status').textContent = 'अतिथी';
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('add-group-btn').style.display = 'none'; // Guests cannot add groups
                document.getElementById('add-new-user-btn').style.display = 'none'; // Guests cannot add users
                document.getElementById('add-contribution-btn').style.display = 'none'; // Guests cannot add contributions
                document.getElementById('add-new-loan-btn').style.display = 'none'; // Guests cannot add loans
                document.getElementById('csv-bulk-uploads-section').style.display = 'none'; // Guests cannot bulk upload
                await loadGroupSelect(); // Load groups after successful login
                showDashboard();
                return true;
            } else {
                flashMessage('चुकीचे वापरकर्तानाव किंवा पासवर्ड.', 'danger');
                return false;
            }
        }

        function logout() {
            currentUserRole = null;
            flashMessage('तुम्ही यशस्वीरित्या लॉग आउट केले आहे.', 'info');
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('auth-status').textContent = '';
            document.getElementById('logout-btn').classList.add('hidden');
            location.reload(); // Reload to clear all states and re-render
        }

        // --- UI Modals ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Group Management ---
        async function loadGroupSelect() {
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.innerHTML = ''; // Clear previous options
            groupData = await getAllData('groups');

            if (groupData.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = getMarathiLabel('no_groups_found'); // A label for no groups found
                groupSelect.appendChild(option);
                flashMessage(getMarathiLabel('no_groups_found'), 'info'); // Inform user
                document.getElementById('dashboard-content').style.display = 'none'; // Hide dashboard if no groups
                return;
            }

            groupData.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });

            // Select the first group by default or previously selected
            if (groupData.length > 0) {
                groupSelect.value = groupData[0].id;
                await renderDashboard(groupData[0].id);
            }
        }

        async function handleAddGroup(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const groupName = document.getElementById('group_name').value.trim();
            const bankAccountDetails = document.getElementById('bank_account_details').value.trim();
            const defaultInterestRate = parseFloat(document.getElementById('default_interest_rate').value);
            const bankInterestRate = parseFloat(document.getElementById('bank_interest_rate').value);


            if (!groupName) {
                flashMessage(getMarathiLabel('group_name_required'), 'danger');
                return;
            }

            if (isNaN(defaultInterestRate)) {
                flashMessage(getMarathiLabel('interest_rate_number_error'), 'danger');
                return;
            }

            if (groupData.some(g => g.name.toLowerCase() === groupName.toLowerCase())) {
                flashMessage(getMarathiLabel('group_exists_error'), 'danger');
                return;
            }

            const newGroup = {
                id: crypto.randomUUID(), // Generate a unique ID for the group
                name: groupName,
                bank_account_details: bankAccountDetails,
                default_interest_rate: defaultInterestRate,
                bank_interest_rate: bankInterestRate,
                created_at: new Date().toISOString(),
                total_contributions: 0,
                total_loans_disbursed: 0,
                total_loan_repayments: 0,
                total_interest_received: 0,
                last_interest_calculation_date: new Date().toISOString().slice(0, 10) // YYYY-MM-DD
            };

            const success = await addData('groups', newGroup);
            if (success) {
                flashMessage(getMarathiLabel('group_added_success'), 'success');
                closeModal('addGroupModal');
                await loadGroupSelect(); // Reload groups in the select dropdown
            } else {
                // Error message already handled by addData
            }
        }

        async function updateGroupBankRate(groupId, newBankRate) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return false;
            }

            if (isNaN(newBankRate) || newBankRate < 0) {
                flashMessage(getMarathiLabel('invalid_bank_interest_rate'), 'danger');
                return false;
            }

            const allGroups = await getAllData('groups');
            const groupIndex = allGroups.findIndex(g => g.id === groupId);

            if (groupIndex === -1) {
                flashMessage(getMarathiLabel('group_not_found', { group_identifier: groupId }), 'danger');
                return false;
            }

            const groupToUpdate = { ...allGroups[groupIndex] }; // Create a copy
            const oldSha = allGroups[groupIndex].sha; // Assuming SHA is part of the object from getAllData response
            groupToUpdate.bank_interest_rate = newBankRate;

            try {
                // For updating, we need the existing SHA
                const filePath = `groups.json`;
                const success = await _fetchGitHubFile(filePath, 'PUT', allGroups, oldSha); // Sending allGroups to update the specific one

                if (success) {
                    flashMessage(getMarathiLabel('update_bank_rate_success'), 'success');
                    await loadGroupSelect(); // Reload groups after update
                    return true;
                } else {
                    flashMessage(getMarathiLabel('error_updating_bank_rate', { error: 'Unknown error' }), 'danger');
                    return false;
                }
            } catch (error) {
                console.error('Error updating bank rate:', error);
                flashMessage(getMarathiLabel('error_updating_bank_rate', { error: error.message }), 'danger');
                return false;
            }
        }


        // --- User Management ---
        async function handleAddUser(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const userName = document.getElementById('user_name_input').value.trim();
            const isAdmin = document.getElementById('is_admin').checked;
            const selectedGroupId = document.getElementById('groupSelect').value;

            if (!userName) {
                flashMessage(getMarathiLabel('user_name_required'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('invalid_group_id'), 'danger');
                return;
            }

            const usersInGroup = (await getAllData('users')).filter(u => u.group_id === selectedGroupId);
            if (usersInGroup.some(u => u.name.toLowerCase() === userName.toLowerCase())) {
                flashMessage(getMarathiLabel('user_exists_error', { user_name: userName }), 'danger');
                return;
            }

            const newUser = {
                id: crypto.randomUUID(),
                group_id: selectedGroupId,
                name: userName,
                is_admin: isAdmin,
                status: 'active', // Default status
                total_contribution: 0,
                pending_contribution: 0,
                total_loan_amount: 0,
                total_loan_paid: 0,
                loans: [], // Array to store individual loan objects
                created_at: new Date().toISOString()
            };

            const success = await addData('users', newUser);
            if (success) {
                flashMessage(getMarathiLabel('user_added_success', { name: userName }), 'success');
                closeModal('addUserModal');
                await renderDashboard(selectedGroupId); // Re-render dashboard
            } else {
                // Error message already handled by addData
            }
        }

        async function toggleUserStatus(userId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            const selectedGroupId = document.getElementById('groupSelect').value;
            let allUsers = await getAllData('users');
            const userIndex = allUsers.findIndex(u => u.id === userId && u.group_id === selectedGroupId);

            if (userIndex === -1) {
                flashMessage(getMarathiLabel('user_not_found'), 'danger');
                return;
            }

            const userToUpdate = allUsers[userIndex];
            userToUpdate.status = userToUpdate.status === 'active' ? 'inactive' : 'active';
            const success = await updateData('users', allUsers); // updateData function handles replacing the entire file
            if (success) {
                flashMessage(getMarathiLabel('user_status_changed', { status: userToUpdate.status }), 'success');
                await renderDashboard(selectedGroupId);
            } else {
                flashMessage(getMarathiLabel('error_updating_user_status'), 'danger');
            }
        }

        async function updateData(dataType, allData) {
            const filePath = `${dataType}.json`; // Already corrected above
            let fileSha = null;
            try {
                // Fetch current SHA to ensure we're updating the latest version
                const githubFileResponse = await _fetchGitHubFile(filePath, 'GET');
                if (githubFileResponse && githubFileResponse.sha) {
                    fileSha = githubFileResponse.sha;
                } else {
                    console.warn(`No SHA found for ${filePath}. This might be a new file.`);
                }
            } catch (error) {
                // If file doesn't exist, proceed without SHA (GitHub will create it)
                if (error.message.includes('404')) {
                    console.warn(`File ${filePath} not found. Will create new.`);
                    fileSha = null;
                } else {
                    console.error(`Error fetching SHA for ${filePath}:`, error);
                    flashMessage(`Error preparing to update ${dataType}: ${error.message}`, 'danger');
                    return false;
                }
            }

            try {
                await _fetchGitHubFile(filePath, 'PUT', allData, fileSha);
                console.log(`Successfully updated ${dataType}.json`);
                return true;
            } catch (error) {
                console.error(`Error updating ${dataType}.json:`, error);
                flashMessage(`Error updating ${dataType}: ${error.message}`, 'danger');
                return false;
            }
        }


        // --- Contribution Management ---
        async function handleAddContribution(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const userId = document.getElementById('user_id_contribution').value;
            const amount = parseFloat(document.getElementById('amount_contribution').value);
            const isCashPayment = document.getElementById('is_cash_payment_contribution').checked;
            const selectedGroupId = document.getElementById('groupSelect').value;

            if (isNaN(amount) || amount <= 0) {
                flashMessage(getMarathiLabel('amount_positive_error'), 'danger');
                return;
            }
            if (!userId || !selectedGroupId) {
                flashMessage(getMarathiLabel('invalid_user_or_group'), 'danger');
                return;
            }

            const allUsers = await getAllData('users');
            const user = allUsers.find(u => u.id === userId && u.group_id === selectedGroupId);
            if (!user) {
                flashMessage(getMarathiLabel('user_not_found_in_group', { group_name: groupData.find(g => g.id === selectedGroupId)?.name, user_name: userId }), 'danger');
                return;
            }

            const newTransaction = {
                id: crypto.randomUUID(),
                user_id: userId,
                group_id: selectedGroupId,
                type: 'contribution',
                amount: amount,
                date: new Date().toISOString(),
                is_cash_payment: isCashPayment,
                is_paid: !isCashPayment, // If not cash, assume paid immediately
                loan_id: null, // Not a loan transaction
                description: 'Monthly contribution'
            };

            const success = await addData('transactions', newTransaction);
            if (success) {
                user.total_contribution += amount;
                if (isCashPayment) {
                    user.pending_contribution += amount;
                }
                const updateSuccess = await updateData('users', allUsers); // Update users file
                if (updateSuccess) {
                    flashMessage(getMarathiLabel('contribution_added_success', { amount: amount, user_name: user.name, status: isCashPayment ? getMarathiLabel('pending_cash_payment') : getMarathiLabel('paid_upi_bank') }), 'success');
                    closeModal('addContributionModal');
                    await renderDashboard(selectedGroupId);
                } else {
                    flashMessage(getMarathiLabel('error_adding_contribution', { error: 'Failed to update user data.' }), 'danger');
                }
            } else {
                // Error message already handled by addData
            }
        }

        async function markCashPaymentPaid(transactionId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            const selectedGroupId = document.getElementById('groupSelect').value;
            let allTransactions = await getAllData('transactions');
            const transactionIndex = allTransactions.findIndex(t => t.id === transactionId && t.group_id === selectedGroupId);

            if (transactionIndex === -1) {
                flashMessage(getMarathiLabel('transaction_not_found'), 'danger');
                return;
            }

            const transactionToUpdate = allTransactions[transactionIndex];

            if (transactionToUpdate.is_paid) {
                flashMessage(getMarathiLabel('payment_already_paid'), 'info');
                return;
            }

            transactionToUpdate.is_paid = true;
            const success = await updateData('transactions', allTransactions);

            if (success) {
                // Update user's pending contribution
                let allUsers = await getAllData('users');
                const user = allUsers.find(u => u.id === transactionToUpdate.user_id && u.group_id === selectedGroupId);
                if (user) {
                    user.pending_contribution -= transactionToUpdate.amount;
                    await updateData('users', allUsers); // Save updated user data
                }
                flashMessage(getMarathiLabel('cash_payment_marked_paid'), 'success');
                closeModal('markPaidModal');
                await renderDashboard(selectedGroupId);
            } else {
                flashMessage(getMarathiLabel('error_marking_paid'), 'danger');
            }
        }

        // --- Loan Management ---
        async function handleAddLoan(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const userId = document.getElementById('user_id_loan').value;
            const loanAmount = parseFloat(document.getElementById('loan_amount').value);
            const loanIssueDate = document.getElementById('loan_issue_date').value;
            const loanInterestRate = parseFloat(document.getElementById('loan_interest_rate').value);
            const selectedGroupId = document.getElementById('groupSelect').value;

            if (isNaN(loanAmount) || loanAmount <= 0) {
                flashMessage(getMarathiLabel('loan_amount_positive_error'), 'danger');
                return;
            }
            if (!loanIssueDate || new Date(loanIssueDate) > new Date()) {
                flashMessage(getMarathiLabel('loan_date_invalid'), 'danger');
                return;
            }
            if (isNaN(loanInterestRate) || loanInterestRate <= 0 || loanInterestRate > 100) {
                flashMessage(getMarathiLabel('invalid_interest_rate', { rate: loanInterestRate }), 'danger');
                return;
            }
            if (!userId || !selectedGroupId) {
                flashMessage(getMarathiLabel('invalid_user_or_group'), 'danger');
                return;
            }

            const allUsers = await getAllData('users');
            const user = allUsers.find(u => u.id === userId && u.group_id === selectedGroupId);
            if (!user) {
                flashMessage(getMarathiLabel('user_not_found_in_group', { group_name: groupData.find(g => g.id === selectedGroupId)?.name, user_name: userId }), 'danger');
                return;
            }

            const newLoan = {
                id: crypto.randomUUID(),
                user_id: userId,
                group_id: selectedGroupId,
                loan_amount: loanAmount,
                outstanding_balance: loanAmount,
                issue_date: loanIssueDate,
                interest_rate: loanInterestRate,
                last_interest_calculation_date: loanIssueDate, // Initial calculation date
                status: 'active',
                repayments: [] // To track individual repayments
            };

            user.loans.push(newLoan); // Add loan to user's loans array
            user.total_loan_amount += loanAmount;

            const success = await updateData('users', allUsers); // Save updated users file
            if (success) {
                // Also add a transaction entry for loan disbursement
                const loanTransaction = {
                    id: crypto.randomUUID(),
                    user_id: userId,
                    group_id: selectedGroupId,
                    type: 'loan_disbursement',
                    amount: loanAmount,
                    date: new Date().toISOString(),
                    is_cash_payment: false, // Loans are typically bank transfers
                    is_paid: true,
                    loan_id: newLoan.id,
                    description: `Loan disbursed to ${user.name}`
                };
                await addData('transactions', loanTransaction); // Add loan disbursement as a transaction

                flashMessage(getMarathiLabel('loan_added_success'), 'success');
                closeModal('addLoanModal');
                await renderDashboard(selectedGroupId);
            } else {
                flashMessage(getMarathiLabel('error_adding_loan', { error: 'Failed to update user data.' }), 'danger');
            }
        }

        async function handleRepayLoan(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const loanId = document.getElementById('repay_loan_id').value;
            const repaymentAmount = parseFloat(document.getElementById('repayment_amount').value);
            const selectedGroupId = document.getElementById('groupSelect').value;

            if (isNaN(repaymentAmount) || repaymentAmount <= 0) {
                flashMessage(getMarathiLabel('repayment_amount_positive_error'), 'danger');
                return;
            }

            let allUsers = await getAllData('users');
            const user = allUsers.find(u => u.group_id === selectedGroupId && u.loans.some(l => l.id === loanId));
            if (!user) {
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }
            const loan = user.loans.find(l => l.id === loanId);
            if (!loan) { // Should not happen if user is found, but as a safeguard
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }

            if (loan.status === 'paid_off') {
                flashMessage(getMarathiLabel('loan_already_paid_off'), 'info');
                return;
            }

            // Calculate outstanding balance with accrued interest
            const now = new Date();
            const lastCalcDate = new Date(loan.last_interest_calculation_date);
            const monthsPassed = (now.getFullYear() - lastCalcDate.getFullYear()) * 12 + (now.getMonth() - lastCalcDate.getMonth());

            if (monthsPassed > 0) {
                const monthlyRate = loan.interest_rate / 100 / 12;
                loan.outstanding_balance *= Math.pow(1 + monthlyRate, monthsPassed);
                loan.last_interest_calculation_date = now.toISOString().slice(0, 10);
            }

            if (repaymentAmount > loan.outstanding_balance + 0.01) { // Add a small tolerance for float comparisons
                flashMessage(getMarathiLabel('repayment_amount_exceeds_loan'), 'danger');
                return;
            }

            loan.outstanding_balance -= repaymentAmount;
            user.total_loan_paid += repaymentAmount;

            // Add repayment to loan's repayment history
            loan.repayments.push({
                amount: repaymentAmount,
                date: new Date().toISOString(),
                type: 'repayment'
            });

            if (loan.outstanding_balance <= 0.01) { // Consider loan paid off if balance is very small
                loan.status = 'paid_off';
                loan.outstanding_balance = 0;
            }

            const success = await updateData('users', allUsers);
            if (success) {
                // Add a transaction entry for loan repayment
                const repaymentTransaction = {
                    id: crypto.randomUUID(),
                    user_id: user.id,
                    group_id: selectedGroupId,
                    type: 'loan_repayment',
                    amount: repaymentAmount,
                    date: new Date().toISOString(),
                    is_cash_payment: false, // Assume bank transfer for repayments
                    is_paid: true,
                    loan_id: loan.id,
                    description: `Loan repayment for loan ID ${loan.id}`
                };
                await addData('transactions', repaymentTransaction);

                flashMessage(getMarathiLabel('loan_repaid_success'), 'success');
                closeModal('repayLoanModal');
                await renderDashboard(selectedGroupId);
            } else {
                flashMessage(getMarathiLabel('error_repaying_loan', { error: 'Failed to update user data.' }), 'danger');
            }
        }

        async function handleChangeInterestRate(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const loanId = document.getElementById('change_rate_loan_id').value;
            const newInterestRate = parseFloat(document.getElementById('new_interest_rate_input').value);
            const selectedGroupId = document.getElementById('groupSelect').value;

            if (isNaN(newInterestRate) || newInterestRate <= 0 || newInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_positive_error'), 'danger');
                return;
            }

            let allUsers = await getAllData('users');
            const user = allUsers.find(u => u.group_id === selectedGroupId && u.loans.some(l => l.id === loanId));
            if (!user) {
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }
            const loan = user.loans.find(l => l.id === loanId);
            if (!loan) {
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }

            loan.interest_rate = newInterestRate;
            const success = await updateData('users', allUsers);

            if (success) {
                flashMessage(getMarathiLabel('interest_rate_change_success'), 'success');
                closeModal('changeInterestRateModal');
                await renderDashboard(selectedGroupId);
            } else {
                flashMessage(getMarathiLabel('error_changing_interest_rate', { error: 'Failed to update loan data.' }), 'danger');
            }
        }

        // --- CSV Bulk Uploads ---
        async function handleBulkUploadTransactions(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const fileInput = document.getElementById('transaction_csv');
            const file = fileInput.files[0];

            if (!file) {
                flashMessage(getMarathiLabel('no_selected_file'), 'danger');
                return;
            }
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                flashMessage(getMarathiLabel('invalid_file_type'), 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { // Only header or empty file
                    flashMessage(getMarathiLabel('no_data_in_csv'), 'info');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                let processedCount = 0;
                let errorCount = 0;
                const errors = [];

                const allUsers = await getAllData('users');
                const allTransactions = await getAllData('transactions');
                const selectedGroupId = document.getElementById('groupSelect').value;

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length !== headers.length) {
                        errors.push(getMarathiLabel('error_processing_row', { error: `Mismatch in column count for row ${i + 1}` }));
                        errorCount++;
                        continue;
                    }

                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = values[index];
                    });

                    try {
                        const userId = rowData['user_id'];
                        const type = rowData['type'];
                        const amount = parseFloat(rowData['amount']);
                        const date = rowData['date'];
                        const isCashPayment = rowData['is_cash_payment'] ? rowData['is_cash_payment'].toLowerCase() === 'true' : false;
                        const loanId = rowData['loan_id'] || null;
                        const description = rowData['description'] || '';

                        if (isNaN(amount) || amount <= 0) {
                            throw new Error(getMarathiLabel('data_conversion_error', { error: 'Invalid amount' }));
                        }
                        if (!userId || !type || !date) {
                            throw new Error(getMarathiLabel('data_conversion_error', { error: 'Missing required fields (user_id, type, date)' }));
                        }

                        const user = allUsers.find(u => u.id === userId && u.group_id === selectedGroupId);
                        if (!user) {
                            throw new Error(getMarathiLabel('user_not_found_in_group', { group_name: groupData.find(g => g.id === selectedGroupId)?.name, user_name: userId }));
                        }

                        const newTransaction = {
                            id: crypto.randomUUID(),
                            user_id: userId,
                            group_id: selectedGroupId,
                            type: type,
                            amount: amount,
                            date: date,
                            is_cash_payment: isCashPayment,
                            is_paid: !isCashPayment,
                            loan_id: loanId,
                            description: description
                        };

                        allTransactions.push(newTransaction);
                        // Update user's total contribution/loan amounts
                        if (type === 'contribution') {
                            user.total_contribution += amount;
                            if (isCashPayment) user.pending_contribution += amount;
                        } else if (type === 'loan_disbursement') {
                            if (loanId) {
                                throw new Error(getMarathiLabel('loan_id_not_for_new_loan'));
                            }
                            user.total_loan_amount += amount;
                            user.loans.push({
                                id: newTransaction.id, // Use transaction ID as loan ID for bulk
                                user_id: userId,
                                group_id: selectedGroupId,
                                loan_amount: amount,
                                outstanding_balance: amount,
                                issue_date: date,
                                interest_rate: parseFloat(rowData['interest_rate']) || groupData.find(g => g.id === selectedGroupId)?.default_interest_rate || 0,
                                last_interest_calculation_date: date,
                                status: 'active',
                                repayments: []
                            });
                        } else if (type === 'loan_repayment') {
                            if (!loanId) {
                                throw new Error(getMarathiLabel('loan_id_missing'));
                            }
                            const loan = user.loans.find(l => l.id === loanId);
                            if (!loan) {
                                throw new Error(getMarathiLabel('loan_not_found', { loan_id: loanId }));
                            }
                            if (loan.status === 'paid_off') {
                                throw new Error(getMarathiLabel('loan_already_paid_off'));
                            }
                            if (amount > loan.outstanding_balance) {
                                throw new Error(getMarathiLabel('repayment_amount_exceeds_loan'));
                            }
                            loan.outstanding_balance -= amount;
                            user.total_loan_paid += amount;
                            loan.repayments.push({ amount, date, type: 'repayment' });
                            if (loan.outstanding_balance <= 0.01) loan.status = 'paid_off';
                        } else {
                            throw new Error(getMarathiLabel('unknown_transaction_type', { transaction_type: type }));
                        }
                        processedCount++;
                    } catch (error) {
                        errors.push(getMarathiLabel('error_processing_row', { error: `Row ${i + 1}: ${error.message}` }));
                        errorCount++;
                    }
                }

                // Save all updated data
                const transactionUpdateSuccess = await updateData('transactions', allTransactions);
                const userUpdateSuccess = await updateData('users', allUsers);

                if (transactionUpdateSuccess && userUpdateSuccess) {
                    flashMessage(getMarathiLabel('upload_complete', { processed_count: processedCount, error_count: errorCount }), 'success');
                } else {
                    flashMessage(getMarathiLabel('upload_error', { error: 'Failed to save some data.' }), 'danger');
                }

                if (errors.length > 0) {
                    console.error('Bulk upload errors:', errors.join('\n'));
                    flashMessage(getMarathiLabel('upload_errors_summary', { count: errors.length }), 'danger');
                }

                await renderDashboard(selectedGroupId);
            };

            reader.readAsText(file);
        }

        async function handleBulkUploadUsers(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const fileInput = document.getElementById('user_csv');
            const file = fileInput.files[0];

            if (!file) {
                flashMessage(getMarathiLabel('no_selected_file'), 'danger');
                return;
            }
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                flashMessage(getMarathiLabel('invalid_file_type'), 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { // Only header or empty file
                    flashMessage(getMarathiLabel('no_data_in_csv'), 'info');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim());
                let processedCount = 0;
                let errorCount = 0;
                const errors = [];

                const allUsers = await getAllData('users');
                const selectedGroupId = document.getElementById('groupSelect').value;

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length !== headers.length) {
                        errors.push(getMarathiLabel('error_processing_row', { error: `Mismatch in column count for row ${i + 1}` }));
                        errorCount++;
                        continue;
                    }

                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = values[index];
                    });

                    try {
                        const userName = rowData['name'];
                        const isAdmin = rowData['is_admin'] ? rowData['is_admin'].toLowerCase() === 'true' : false;

                        if (!userName) {
                            throw new Error(getMarathiLabel('data_conversion_error', { error: 'User name is required' }));
                        }

                        if (allUsers.some(u => u.name.toLowerCase() === userName.toLowerCase() && u.group_id === selectedGroupId)) {
                            throw new Error(getMarathiLabel('user_exists_error', { user_name: userName }));
                        }

                        const newUser = {
                            id: crypto.randomUUID(),
                            group_id: selectedGroupId,
                            name: userName,
                            is_admin: isAdmin,
                            status: 'active',
                            total_contribution: 0,
                            pending_contribution: 0,
                            total_loan_amount: 0,
                            total_loan_paid: 0,
                            loans: [],
                            created_at: new Date().toISOString()
                        };
                        allUsers.push(newUser);
                        processedCount++;
                    } catch (error) {
                        errors.push(getMarathiLabel('error_processing_row', { error: `Row ${i + 1}: ${error.message}` }));
                        errorCount++;
                    }
                }

                const success = await updateData('users', allUsers);
                if (success) {
                    flashMessage(getMarathiLabel('upload_complete', { processed_count: processedCount, error_count: errorCount }), 'success');
                } else {
                    flashMessage(getMarathiLabel('upload_error', { error: 'Failed to save users data.' }), 'danger');
                }

                if (errors.length > 0) {
                    console.error('Bulk upload errors:', errors.join('\n'));
                    flashMessage(getMarathiLabel('upload_errors_summary', { count: errors.length }), 'danger');
                }
                await renderDashboard(selectedGroupId);
            };
            reader.readAsText(file);
        }

        function downloadSampleTransactionsCsv() {
            const csvContent = "user_id,type,amount,date,is_cash_payment,loan_id,description,interest_rate\n" +
                               "user123,contribution,1000.00,2023-01-15,FALSE,,Monthly contribution\n" +
                               "user456,loan_disbursement,5000.00,2023-02-01,FALSE,,New loan,12.0\n" +
                               "user456,loan_repayment,500.00,2023-03-01,FALSE,loan_id_from_above,Loan repayment\n";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'sample_transactions.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadSampleUsersCsv() {
            const csvContent = "name,is_admin\n" +
                               "John Doe,FALSE\n" +
                               "Jane Smith,TRUE\n";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'sample_users.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- Dashboard Rendering ---
        async function renderDashboard(groupId) {
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'none';

            const selectedGroup = groupData.find(g => g.id === groupId);
            if (!selectedGroup) {
                flashMessage(getMarathiLabel('group_not_found', { group_identifier: groupId }), 'danger');
                return;
            }

            document.getElementById('group-financial-summary-heading').textContent = getMarathiLabel('group_financial_summary') + `: ${selectedGroup.name}`;
            document.getElementById('users-and-loans-summary-heading').textContent = getMarathiLabel('users_and_loans_summary') + `: ${selectedGroup.name}`;

            await updateGroupSummary(selectedGroup);
            await renderUsersTable(groupId);
            await populateContributionAndLoanModals(groupId);
        }

        async function updateGroupSummary(group) {
            // Recalculate group-level totals from users and transactions
            const allUsers = await getAllData('users');
            const groupUsers = allUsers.filter(u => u.group_id === group.id);

            const allTransactions = await getAllData('transactions');
            const groupTransactions = allTransactions.filter(t => t.group_id === group.id);

            let totalContributions = 0;
            let totalLoansDisbursed = 0;
            let totalLoanRepayments = 0;
            let totalInterestReceived = 0; // This will be calculated from loans

            groupUsers.forEach(user => {
                totalContributions += user.total_contribution;
                user.loans.forEach(loan => {
                    totalLoansDisbursed += loan.loan_amount;
                    totalLoanRepayments += loan.repayments.reduce((sum, r) => sum + r.amount, 0);

                    // Calculate interest received for each loan
                    const loanIssueDate = new Date(loan.issue_date);
                    const lastCalcDate = new Date(loan.last_interest_calculation_date);
                    const now = new Date();

                    let monthsAccrued = 0;
                    if (loan.status !== 'paid_off') {
                        // Calculate months passed since last calculation or issue date
                        monthsAccrued = (now.getFullYear() - lastCalcDate.getFullYear()) * 12 + (now.getMonth() - lastCalcDate.getMonth());
                    }

                    // Interest calculation should consider outstanding balance
                    let currentOutstanding = loan.loan_amount; // Start with original loan amount
                    let totalLoanInterest = 0;

                    // Simulate interest accrual and repayments
                    let tempDate = new Date(loanIssueDate);
                    let tempOutstanding = loan.loan_amount;

                    // Sort repayments by date to apply them in order
                    const sortedRepayments = [...loan.repayments].sort((a, b) => new Date(a.date) - new Date(b.date));

                    let repaymentIndex = 0;
                    while (tempDate <= now) {
                        // Accrue interest for the current month
                        const monthlyRate = loan.interest_rate / 100 / 12;
                        const interestForMonth = tempOutstanding * monthlyRate;
                        totalLoanInterest += interestForMonth;
                        tempOutstanding += interestForMonth;

                        // Apply repayments that occurred in this month
                        while (repaymentIndex < sortedRepayments.length && new Date(sortedRepayments[repaymentIndex].date).getMonth() === tempDate.getMonth() && new Date(sortedRepayments[repaymentIndex].date).getFullYear() === tempDate.getFullYear()) {
                            tempOutstanding -= sortedRepayments[repaymentIndex].amount;
                            repaymentIndex++;
                        }
                        
                        // Move to the next month
                        tempDate.setMonth(tempDate.getMonth() + 1);
                        if (tempDate.getMonth() === 0) { // If month rolls over to Jan, increment year
                            tempDate.setFullYear(tempDate.getFullYear() + 1);
                        }
                        if (tempOutstanding <= 0) { // Stop if loan is paid off
                            totalLoanInterest -= tempOutstanding; // Adjust if overpaid interest
                            tempOutstanding = 0;
                            break;
                        }
                    }
                    totalInterestReceived += totalLoanInterest;
                });
            });


            const overallProfit = totalContributions + totalInterestReceived - totalLoansDisbursed; // Simplified profit calculation

            document.getElementById('group-summary-reports').innerHTML = `
                <div class="report-widget profit">
                    <h3 class="text-lg font-medium">${getMarathiLabel('overall_profit')}</h3>
                    <p class="text-3xl font-bold">₹${overallProfit.toFixed(2)}</p>
                </div>
                <div class="report-widget">
                    <h3 class="text-lg font-medium">${getMarathiLabel('total_contributions')}</h3>
                    <p class="text-3xl font-bold">₹${totalContributions.toFixed(2)}</p>
                </div>
                <div class="report-widget loan">
                    <h3 class="text-lg font-medium">${getMarathiLabel('total_loans_disbursed')}</h3>
                    <p class="text-3xl font-bold">₹${totalLoansDisbursed.toFixed(2)}</p>
                </div>
                <div class="report-widget">
                    <h3 class="text-lg font-medium">${getMarathiLabel('total_loan_repayments')}</h3>
                    <p class="text-3xl font-bold">₹${totalLoanRepayments.toFixed(2)}</p>
                </div>
                <div class="report-widget profit">
                    <h3 class="text-lg font-medium">${getMarathiLabel('total_interest_received')}</h3>
                    <p class="text-3xl font-bold">₹${totalInterestReceived.toFixed(2)}</p>
                </div>
                `;
        }


        async function renderUsersTable(groupId) {
            const usersDataTbody = document.getElementById('users-data-tbody');
            usersDataTbody.innerHTML = ''; // Clear previous rows

            const allUsers = await getAllData('users');
            const groupUsers = allUsers.filter(u => u.group_id === groupId);

            if (groupUsers.length === 0) {
                usersDataTbody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500">${getMarathiLabel('no_users_found')}</td></tr>`;
                return;
            }

            groupUsers.forEach(user => {
                let pendingLoanAmountWithInterest = 0;
                user.loans.filter(loan => loan.status === 'active').forEach(loan => {
                    // Recalculate outstanding balance with current interest
                    const now = new Date();
                    const lastCalcDate = new Date(loan.last_interest_calculation_date);
                    const monthsPassed = (now.getFullYear() - lastCalcDate.getFullYear()) * 12 + (now.getMonth() - lastCalcDate.getMonth());

                    let currentOutstanding = loan.outstanding_balance;
                    if (monthsPassed > 0) {
                        const monthlyRate = loan.interest_rate / 100 / 12;
                        currentOutstanding *= Math.pow(1 + monthlyRate, monthsPassed);
                    }
                    pendingLoanAmountWithInterest += currentOutstanding;
                });

                const row = usersDataTbody.insertRow();
                row.insertCell().textContent = user.name;
                row.insertCell().innerHTML = `<span class="${user.status === 'active' ? 'status-received' : 'status-pending'}">${getMarathiLabel(user.status)}</span>`;
                row.insertCell().textContent = `₹${user.total_contribution.toFixed(2)}`;
                row.insertCell().textContent = `₹${user.pending_contribution.toFixed(2)}`;
                row.insertCell().textContent = `₹${pendingLoanAmountWithInterest.toFixed(2)}`;
                row.insertCell().textContent = `₹${user.total_loan_paid.toFixed(2)}`;

                // Loan Details Button
                const loanDetailsCell = row.insertCell();
                if (user.loans && user.loans.length > 0) {
                    const viewLoansBtn = document.createElement('button');
                    viewLoansBtn.textContent = getMarathiLabel('view_loans');
                    viewLoansBtn.className = 'btn btn-info btn-sm';
                    viewLoansBtn.onclick = () => showLoanDetailsModal(user.id);
                    loanDetailsCell.appendChild(viewLoansBtn);
                } else {
                    loanDetailsCell.textContent = getMarathiLabel('no_loans');
                }


                const actionsCell = row.insertCell();
                const toggleBtn = document.createElement('button');
                toggleBtn.textContent = getMarathiLabel('toggle_status');
                toggleBtn.className = 'btn btn-secondary btn-sm mr-2';
                toggleBtn.onclick = () => toggleUserStatus(user.id);
                if (currentUserRole !== 'admin') {
                    toggleBtn.disabled = true;
                }

                const viewTransactionsBtn = document.createElement('button');
                viewTransactionsBtn.textContent = getMarathiLabel('view_transactions');
                viewTransactionsBtn.className = 'btn btn-info btn-sm';
                viewTransactionsBtn.onclick = () => showTransactionHistory(user.id, user.name);

                actionsCell.appendChild(toggleBtn);
                actionsCell.appendChild(viewTransactionsBtn);
            });
        }


        async function populateContributionAndLoanModals(groupId) {
            const userIdContributionSelect = document.getElementById('user_id_contribution');
            const userIdLoanSelect = document.getElementById('user_id_loan');

            userIdContributionSelect.innerHTML = '';
            userIdLoanSelect.innerHTML = '';

            const allUsers = await getAllData('users');
            const groupUsers = allUsers.filter(u => u.group_id === groupId);

            groupUsers.forEach(user => {
                const optionContrib = document.createElement('option');
                optionContrib.value = user.id;
                optionContrib.textContent = user.name;
                userIdContributionSelect.appendChild(optionContrib);

                const optionLoan = document.createElement('option');
                optionLoan.value = user.id;
                optionLoan.textContent = user.name;
                userIdLoanSelect.appendChild(optionLoan);
            });
        }

        function showDashboard() {
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'none';
        }

        // --- All Groups Report ---
        async function showAllGroupsReport() {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('all-groups-report-content').style.display = 'block';
            document.getElementById('view-transactions-content').style.display = 'none';

            const allGroupsReportCards = document.getElementById('all-groups-report-cards');
            allGroupsReportCards.innerHTML = '';

            const allGroups = await getAllData('groups');
            if (allGroups.length === 0) {
                allGroupsReportCards.innerHTML = `<p class="text-gray-500">${getMarathiLabel('no_groups_found')}</p>`;
                return;
            }

            let totalProfitAllGroups = 0;
            let totalInvestedAllGroups = 0;
            let totalLoanGivenAllGroups = 0;
            let totalLoanRepaidAllGroups = 0;

            for (const group of allGroups) {
                const allUsers = await getAllData('users');
                const groupUsers = allUsers.filter(u => u.group_id === group.id);
                const allTransactions = await getAllData('transactions');
                const groupTransactions = allTransactions.filter(t => t.group_id === group.id);

                let groupTotalContributions = 0;
                let groupTotalLoansDisbursed = 0;
                let groupTotalLoanRepayments = 0;
                let groupTotalInterestReceived = 0;

                groupUsers.forEach(user => {
                    groupTotalContributions += user.total_contribution;
                    user.loans.forEach(loan => {
                        groupTotalLoansDisbursed += loan.loan_amount;
                        groupTotalLoanRepayments += loan.repayments.reduce((sum, r) => sum + r.amount, 0);

                        const loanIssueDate = new Date(loan.issue_date);
                        const lastCalcDate = new Date(loan.last_interest_calculation_date);
                        const now = new Date();

                        let currentOutstanding = loan.loan_amount;
                        let totalLoanInterest = 0;

                        const sortedRepayments = [...loan.repayments].sort((a, b) => new Date(a.date) - new Date(b.date));
                        let repaymentIndex = 0;
                        let tempDate = new Date(loanIssueDate);
                        
                        while (tempDate <= now) {
                             const monthlyRate = loan.interest_rate / 100 / 12;
                             const interestForMonth = currentOutstanding * monthlyRate;
                             totalLoanInterest += interestForMonth;
                             currentOutstanding += interestForMonth;

                             while (repaymentIndex < sortedRepayments.length && new Date(sortedRepayments[repaymentIndex].date).getMonth() === tempDate.getMonth() && new Date(sortedRepayments[repaymentIndex].date).getFullYear() === tempDate.getFullYear()) {
                                 currentOutstanding -= sortedRepayments[repaymentIndex].amount;
                                 repaymentIndex++;
                             }
                             
                             tempDate.setMonth(tempDate.getMonth() + 1);
                             if (tempDate.getMonth() === 0) {
                                 tempDate.setFullYear(tempDate.getFullYear() + 1);
                             }
                             if (currentOutstanding <= 0) {
                                totalLoanInterest -= currentOutstanding;
                                currentOutstanding = 0;
                                 break;
                             }
                        }
                        groupTotalInterestReceived += totalLoanInterest;
                    });
                });

                const groupProfit = groupTotalContributions + groupTotalInterestReceived - groupTotalLoansDisbursed;

                totalProfitAllGroups += groupProfit;
                totalInvestedAllGroups += groupTotalContributions;
                totalLoanGivenAllGroups += groupTotalLoansDisbursed;
                totalLoanRepaidAllGroups += groupTotalRepayments;

                const card = document.createElement('div');
                card.className = 'card mb-4';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">${group.name}</h3>
                    <div class="report-grid">
                        <div class="report-widget profit">
                            <h4 class="text-md font-medium">${getMarathiLabel('group_profit_label')}</h4>
                            <p class="text-2xl font-bold">₹${groupProfit.toFixed(2)}</p>
                        </div>
                        <div class="report-widget">
                            <h4 class="text-md font-medium">${getMarathiLabel('total_contributions')}</h4>
                            <p class="text-2xl font-bold">₹${groupTotalContributions.toFixed(2)}</p>
                        </div>
                        <div class="report-widget loan">
                            <h4 class="text-md font-medium">${getMarathiLabel('total_loans_disbursed')}</h4>
                            <p class="text-2xl font-bold">₹${groupTotalLoansDisbursed.toFixed(2)}</p>
                        </div>
                        <div class="report-widget">
                            <h4 class="text-md font-medium">${getMarathiLabel('total_loan_repayments')}</h4>
                            <p class="text-2xl font-bold">₹${groupTotalLoanRepayments.toFixed(2)}</p>
                        </div>
                        <div class="report-widget profit">
                            <h4 class="text-md font-medium">${getMarathiLabel('total_interest_received')}</h4>
                            <p class="text-2xl font-bold">₹${groupTotalInterestReceived.toFixed(2)}</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary mt-4" onclick="renderDashboard('${group.id}')">${getMarathiLabel('view_dashboard')}</button>
                    <button class="btn btn-primary mt-4 ml-2" onclick="openUpdateBankRateModal('${group.id}', ${group.bank_interest_rate || 0})">${getMarathiLabel('edit_bank_interest_rate')}</button>

                `;
                allGroupsReportCards.appendChild(card);
            }

            // Overall Summary for all groups
            const overallSummaryCard = document.createElement('div');
            overallSummaryCard.className = 'card mb-4 bg-green-100 border-green-400';
            overallSummaryCard.innerHTML = `
                <h3 class="text-xl font-semibold mb-2">${getMarathiLabel('overall_financial_summary_all_groups')}</h3>
                <div class="report-grid">
                    <div class="report-widget profit">
                        <h4 class="text-md font-medium">${getMarathiLabel('total_profit_all_groups')}</h4>
                        <p class="text-3xl font-bold">₹${totalProfitAllGroups.toFixed(2)}</p>
                    </div>
                    <div class="report-widget">
                        <h4 class="text-md font-medium">${getMarathiLabel('total_invested_all_groups')}</h4>
                        <p class="text-3xl font-bold">₹${totalInvestedAllGroups.toFixed(2)}</p>
                    </div>
                    <div class="report-widget loan">
                        <h4 class="text-md font-medium">${getMarathiLabel('total_loan_given_all_groups')}</h4>
                        <p class="text-3xl font-bold">₹${totalLoanGivenAllGroups.toFixed(2)}</p>
                    </div>
                    <div class="report-widget">
                        <h4 class="text-md font-medium">${getMarathiLabel('total_loan_repaid_all_groups')}</h4>
                        <p class="text-3xl font-bold">₹${totalLoanRepaidAllGroups.toFixed(2)}</p>
                    </div>
                </div>
            `;
            allGroupsReportCards.prepend(overallSummaryCard);
        }

        // --- Transaction History ---
        async function showTransactionHistory(userId, userName) {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'block';

            document.getElementById('view-transactions-header').textContent = getMarathiLabel('view_transactions');
            document.getElementById('view-transactions-user-name').textContent = getMarathiLabel('user_transaction_history_for', { user_name: userName });
            document.getElementById('filter-user-id').value = userId; // Set the user ID for filtering

            await renderTransactionsTable(userId);
        }

        async function renderTransactionsTable(userId, fromDate = null, toDate = null) {
            const transactionsDataTbody = document.getElementById('transactions-data-tbody');
            transactionsDataTbody.innerHTML = '';
            document.getElementById('no-transactions-found').style.display = 'none';

            const allTransactions = await getAllData('transactions');
            let userTransactions = allTransactions.filter(t => t.user_id === userId);

            // Apply date filters
            if (fromDate) {
                userTransactions = userTransactions.filter(t => new Date(t.date) >= new Date(fromDate));
            }
            if (toDate) {
                userTransactions = userTransactions.filter(t => new Date(t.date) <= new Date(toDate));
            }

            if (userTransactions.length === 0) {
                document.getElementById('no-transactions-found').textContent = getMarathiLabel('no_transactions_found');
                document.getElementById('no-transactions-found').style.display = 'block';
                return;
            }

            userTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            userTransactions.forEach(transaction => {
                const row = transactionsDataTbody.insertRow();
                row.insertCell().textContent = new Date(transaction.date).toLocaleDateString('mr-IN');
                row.insertCell().textContent = getMarathiLabel(transaction.type); // Localize transaction type
                row.insertCell().textContent = `₹${transaction.amount.toFixed(2)}`;
                row.insertCell().innerHTML = transaction.is_cash_payment ? getMarathiLabel('yes') : getMarathiLabel('no');
                
                const isPaidCell = row.insertCell();
                if (transaction.type === 'contribution' && transaction.is_cash_payment && !transaction.is_paid) {
                    const markPaidBtn = document.createElement('button');
                    markPaidBtn.textContent = getMarathiLabel('mark_paid');
                    markPaidBtn.className = 'btn btn-primary btn-sm';
                    markPaidBtn.onclick = () => {
                        document.getElementById('mark-paid-transaction-id').value = transaction.id;
                        document.getElementById('mark-paid-confirmation-text').textContent = getMarathiLabel('mark_paid_confirmation');
                        openModal('markPaidModal');
                    };
                    isPaidCell.appendChild(markPaidBtn);
                } else {
                    isPaidCell.innerHTML = `<span class="${transaction.is_paid ? 'status-paid' : 'status-pending'}">${getMarathiLabel(transaction.is_paid ? 'paid' : 'pending')}</span>`;
                }

                row.insertCell().textContent = transaction.loan_id || getMarathiLabel('not_applicable');
                row.insertCell().textContent = transaction.loan_id ? (transaction.interest_rate ? `${transaction.interest_rate}%` : getMarathiLabel('not_applicable')) : getMarathiLabel('not_applicable'); // Display interest rate for loan transactions if available
                row.insertCell().textContent = transaction.description || '';
            });
        }

        async function handleFilterTransactions(event) {
            event.preventDefault();
            const userId = document.getElementById('filter-user-id').value;
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;
            await renderTransactionsTable(userId, fromDate, toDate);
        }

        async function clearTransactionFilter() {
            document.getElementById('filter-from-date').value = '';
            document.getElementById('filter-to-date').value = '';
            const userId = document.getElementById('filter-user-id').value;
            await renderTransactionsTable(userId);
        }

        async function downloadTransactionsCsv() {
            const userId = document.getElementById('filter-user-id').value;
            const userName = document.getElementById('view-transactions-user-name').textContent.replace(getMarathiLabel('user_transaction_history_for', { user_name: '' }).trim(), '');
            const allTransactions = await getAllData('transactions');
            const userTransactions = allTransactions.filter(t => t.user_id === userId);

            let csvContent = "Date,Type,Amount,Is Cash Payment,Is Paid,Loan ID,Description\n";
            userTransactions.forEach(t => {
                csvContent += `${new Date(t.date).toLocaleDateString('en-CA')},${t.type},${t.amount.toFixed(2)},${t.is_cash_payment},${t.is_paid},${t.loan_id || ''},"${t.description || ''}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `${userName}_transactions_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Loan Details Modal ---
        async function showLoanDetailsModal(userId) {
            const allUsers = await getAllData('users');
            const user = allUsers.find(u => u.id === userId);
            if (!user || !user.loans || user.loans.length === 0) {
                flashMessage(getMarathiLabel('no_loans_found'), 'info');
                return;
            }

            let loanDetailsHtml = `
                <h2 class="text-xl font-semibold mb-4">${getMarathiLabel('loan_details_for')} ${user.name}</h2>
                <div class="overflow-x-auto">
                <table class="user-table w-full text-sm">
                    <thead>
                        <tr>
                            <th>${getMarathiLabel('loan_id')}</th>
                            <th>${getMarathiLabel('loan_amount')}</th>
                            <th>${getMarathiLabel('outstanding_balance')}</th>
                            <th>${getMarathiLabel('loan_issue_date')}</th>
                            <th>${getMarathiLabel('loan_interest_rate')}</th>
                            <th>${getMarathiLabel('status')}</th>
                            <th>${getMarathiLabel('actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            user.loans.forEach(loan => {
                // Calculate current outstanding balance with interest
                const now = new Date();
                const lastCalcDate = new Date(loan.last_interest_calculation_date);
                const monthsPassed = (now.getFullYear() - lastCalcDate.getFullYear()) * 12 + (now.getMonth() - lastCalcDate.getMonth());
                
                let currentOutstanding = loan.outstanding_balance;
                if (loan.status === 'active' && monthsPassed > 0) {
                    const monthlyRate = loan.interest_rate / 100 / 12;
                    currentOutstanding *= Math.pow(1 + monthlyRate, monthsPassed);
                }

                loanDetailsHtml += `
                    <tr>
                        <td>${loan.id.slice(0, 8)}...</td>
                        <td>₹${loan.loan_amount.toFixed(2)}</td>
                        <td>₹${currentOutstanding.toFixed(2)}</td>
                        <td>${new Date(loan.issue_date).toLocaleDateString('mr-IN')}</td>
                        <td>${loan.interest_rate}%</td>
                        <td><span class="${loan.status === 'active' ? 'status-received' : 'status-pending'}">${getMarathiLabel(loan.status)}</span></td>
                        <td>
                            ${loan.status === 'active' ? `
                                <button class="btn btn-primary btn-sm mr-1" onclick="openRepayLoanModal('${loan.id}', ${currentOutstanding}, ${loan.interest_rate}, '${loan.last_interest_calculation_date}')">${getMarathiLabel('repay_loan')}</button>
                                <button class="btn btn-secondary btn-sm" onclick="openChangeInterestRateModal('${loan.id}', ${loan.interest_rate})">${getMarathiLabel('change_interest_rate')}</button>
                            ` : getMarathiLabel('not_applicable')}
                        </td>
                    </tr>
                `;
            });

            loanDetailsHtml += `
                    </tbody>
                </table>
                </div>
                <div class="mt-4 text-right">
                    <button class="btn btn-danger" onclick="closeModal('loanDetailsModal')">${getMarathiLabel('close')}</button>
                </div>
            `;

            const loanDetailsModal = document.getElementById('loanDetailsModal');
            if (!loanDetailsModal) { // Create the modal if it doesn't exist
                const newModal = document.createElement('div');
                newModal.id = 'loanDetailsModal';
                newModal.className = 'modal';
                newModal.innerHTML = `<div class="modal-content"><span class="close-button" onclick="closeModal('loanDetailsModal')">&times;</span><div id="loanDetailsContent"></div></div>`;
                document.body.appendChild(newModal);
            }
            document.getElementById('loanDetailsContent').innerHTML = loanDetailsHtml;
            openModal('loanDetailsModal');
        }

        function openRepayLoanModal(loanId, outstandingBalance, interestRate, lastCalcDate) {
            document.getElementById('repay_loan_id').value = loanId;
            document.getElementById('display_repay_loan_id').textContent = loanId.slice(0, 8) + '...';
            document.getElementById('display_outstanding_balance').textContent = outstandingBalance.toFixed(2);
            document.getElementById('display_current_interest_rate').textContent = interestRate;
            document.getElementById('display_last_interest_calc_date').textContent = new Date(lastCalcDate).toLocaleDateString('mr-IN');
            openModal('repayLoanModal');
        }

        function openChangeInterestRateModal(loanId, currentRate) {
            document.getElementById('change_rate_loan_id').value = loanId;
            document.getElementById('display_change_rate_loan_id').textContent = loanId.slice(0, 8) + '...';
            document.getElementById('display_old_interest_rate').textContent = currentRate;
            document.getElementById('new_interest_rate_input').value = currentRate;
            openModal('changeInterestRateModal');
        }


        // --- Event Listeners ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        document.getElementById('logout-btn').addEventListener('click', logout);

        document.getElementById('groupSelect').addEventListener('change', async (e) => {
            const selectedGroupId = e.target.value;
            if (selectedGroupId) {
                await renderDashboard(selectedGroupId);
            } else {
                document.getElementById('dashboard-content').style.display = 'none';
            }
        });

        document.getElementById('add-group-form').addEventListener('submit', handleAddGroup);
        document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
        document.getElementById('add-contribution-form').addEventListener('submit', handleAddContribution);
        document.getElementById('add-loan-form').addEventListener('submit', handleAddLoan);
        document.getElementById('repay-loan-form').addEventListener('submit', handleRepayLoan);
        document.getElementById('change-interest-rate-form').addEventListener('submit', handleChangeInterestRate);
        document.getElementById('markPaidForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const transactionId = document.getElementById('mark-paid-transaction-id').value;
            await markCashPaymentPaid(transactionId);
        });

        document.getElementById('bulk-upload-transactions-form').addEventListener('submit', handleBulkUploadTransactions);
        document.getElementById('bulk-upload-users-form').addEventListener('submit', handleBulkUploadUsers);
        document.getElementById('filter-transactions-form').addEventListener('submit', handleFilterTransactions);

        document.getElementById('update-bank-rate-form-2').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newBankRate = parseFloat(document.getElementById('new_bank_interest_rate_input_2').value);
            const selectedGroupId = document.getElementById('groupSelect').value;
            if (selectedGroupId) {
                await updateGroupBankRate(selectedGroupId, newBankRate);
                closeModal('updateBankRateModal');
            } else {
                flashMessage(getMarathiLabel('invalid_group_id'), 'danger');
            }
        });


        // Initial language and UI setup
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('app-name-header').textContent = getMarathiLabel('app_name');
            document.getElementById('select-group-heading').textContent = getMarathiLabel('select_group');
            document.getElementById('add-group-btn').textContent = getMarathiLabel('add_group');
            document.getElementById('group-name-label').textContent = getMarathiLabel('group_name');
            document.getElementById('bank-account-details-label').textContent = getMarathiLabel('bank_account_details');
            document.getElementById('default-interest-rate-label').textContent = getMarathiLabel('default_interest_rate');
            document.getElementById('bank-interest-rate-label').textContent = getMarathiLabel('bank_interest_rate');
            document.getElementById('add-group-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('add-group-modal-heading').textContent = getMarathiLabel('add_group');
            document.getElementById('view-all-groups-report-btn').textContent = getMarathiLabel('view_all_groups_report');
            document.getElementById('back-to-dashboard-btn-report').textContent = getMarathiLabel('back_to_dashboard');
            document.getElementById('back-to-dashboard-btn-transactions').textContent = getMarathiLabel('back_to_dashboard');
            document.getElementById('add-new-user-btn').textContent = getMarathiLabel('add_new_user');
            document.getElementById('user-name-input-label').textContent = getMarathiLabel('user_name_input');
            document.getElementById('is-admin-label').textContent = getMarathiLabel('is_admin');
            document.getElementById('add-user-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('add-contribution-btn').textContent = getMarathiLabel('add_contribution');
            document.getElementById('user-name-contribution-label').textContent = getMarathiLabel('user_name');
            document.getElementById('amount-label-contribution').textContent = getMarathiLabel('amount');
            document.getElementById('is-cash-payment-label-contribution').textContent = getMarathiLabel('is_cash_payment');
            document.getElementById('add-contribution-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('add-new-loan-btn').textContent = getMarathiLabel('add_new_loan');
            document.getElementById('user-name-loan-label').textContent = getMarathiLabel('user_name');
            document.getElementById('loan-amount-label').textContent = getMarathiLabel('loan_amount');
            document.getElementById('loan-issue-date-label').textContent = getMarathiLabel('loan_issue_date');
            document.getElementById('loan-interest-rate-label').textContent = getMarathiLabel('loan_interest_rate');
            document.getElementById('add-loan-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('download-users-csv-btn').textContent = getMarathiLabel('download_users_csv');
            document.getElementById('user-name-th').textContent = getMarathiLabel('user_name');
            document.getElementById('monthly-contribution-status-th').textContent = getMarathiLabel('monthly_contribution_status');
            document.getElementById('total-contribution-by-user-th').textContent = getMarathiLabel('total_contributions');
            document.getElementById('pending-contribution-by-user-th').textContent = getMarathiLabel('pending_contribution');
            document.getElementById('pending-loan-amount-with-interest-th').textContent = getMarathiLabel('remaining_loan_amount_with_interest');
            document.getElementById('total-amount-paid-by-user-till-date-th').textContent = getMarathiLabel('total_amount_paid_by_user_till_date'); // Assuming this label exists
            document.getElementById('loan-details-th').textContent = getMarathiLabel('loan_details');
            document.getElementById('actions-th').textContent = getMarathiLabel('actions');
            document.getElementById('view-transactions-header').textContent = getMarathiLabel('view_transactions');
            document.getElementById('filter-transactions-heading').textContent = getMarathiLabel('filter_transactions');
            document.getElementById('from-date-label').textContent = getMarathiLabel('from_date');
            document.getElementById('to-date-label').textContent = getMarathiLabel('to_date');
            document.getElementById('apply-filter-btn').textContent = getMarathiLabel('apply_filter');
            document.getElementById('clear-filter-btn').textContent = getMarathiLabel('clear_filter');
            document.getElementById('transaction-history-heading').textContent = getMarathiLabel('transaction_history');
            document.getElementById('download-transactions-csv-btn').textContent = getMarathiLabel('download_transactions_csv');
            document.getElementById('edit-bank-interest-rate-modal-heading').textContent = getMarathiLabel('edit_bank_interest_rate');
            document.getElementById('new-interest-rate-label').textContent = getMarathiLabel('new_interest_rate_label');
            document.getElementById('update-bank-rate-submit-btn').textContent = getMarathiLabel('update');
            document.getElementById('edit-bank-interest-rate-modal-heading-2').textContent = getMarathiLabel('edit_bank_interest_rate');
            document.getElementById('new-interest-rate-label-2').textContent = getMarathiLabel('new_interest_rate_label');
            document.getElementById('update-bank-rate-submit-btn-2').textContent = getMarathiLabel('update');


            // Initially show login modal
            document.getElementById('loginModal').style.display = 'block';
        });
    </script>
</body>
</html>
