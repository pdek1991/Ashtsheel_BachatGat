<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अष्टशील बचत गट</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
            border: none;
        }
        .btn-secondary {
            background-color: #007bff;
            color: white;
            border: none;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
            border: none;
        }
        .flash-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: white;
        }
        .flash-success {
            background-color: #28a745;
        }
        .flash-danger {
            background-color: #dc3545;
        }
        .flash-info {
            background-color: #17a2b8;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Table styles for user summary */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .user-table th, .user-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .user-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .user-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .user-table tr:hover {
            background-color: #f1f1f1;
        }
        .status-received {
            color: green;
            font-weight: bold;
        }
        .status-pending {
            color: red;
            font-weight: bold;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .report-widget {
            background-color: #e6f7ff; /* Light blue */
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .report-widget.profit {
            background-color: #d4edda; /* Light green for profit */
            border-color: #28a745;
        }
         .report-widget.loan {
            background-color: #f8d7da; /* Light red for loan/pending */
            border-color: #dc3545;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #e2e8f0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
        }
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 2px solid #4CAF50;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .table-container {
            overflow-x: auto;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .transaction-table th, .transaction-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            white-space: nowrap; /* Prevent wrapping for better readability of data */
        }
        .transaction-table th {
            background-color: #f2f2f2;
            font-weight: 600;
            color: #555;
        }
        .transaction-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .transaction-table tbody tr:hover {
            background-color: #f1f1f1;
        }
        .status-paid {
            color: green;
            font-weight: bold;
        }
        .status-pending {
            color: orange;
            font-weight: bold;
        }
        .status-not-applicable {
            color: gray;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="header flex justify-between items-center">
            <h1 class="text-3xl font-bold" id="app-name-header"></h1>
            <div id="auth-status" class="text-white text-lg font-medium"></div>
            <button id="logout-btn" class="btn btn-danger hidden">Logout</button>
        </header>

        <div id="flash-messages" class="messages mb-4"></div>

        <div id="loginModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <p class="text-sm text-gray-600 mt-4">Admin: admin/admin | Guest: guest/guest</p>
            </div>
        </div>

        <div id="app-content" style="display: none;">
            <div class="card mb-6" id="group-selection-card">
                <h2 class="text-xl font-semibold mb-4" id="select-group-heading"></h2>
                <div class="mb-4 flex items-center space-x-4">
                    <select name="group_id" id="groupSelect" class="form-control flex-grow border rounded p-2"></select>
                    <button type="button" class="btn btn-primary" onclick="openModal('addGroupModal')" id="add-group-btn"></button>
                </div>
                <button type="button" class="btn btn-secondary mt-2 inline-block" onclick="showAllGroupsReport()" id="view-all-groups-report-btn"></button>
            </div>

            <div id="dashboard-content" style="display: none;">
                <div class="card mb-6">
                    <h2 class="text-2xl font-bold mb-4" id="group-financial-summary-heading"></h2>
                    <div class="report-grid" id="group-summary-reports">
                        </div>
                </div>

                <div class="card mb-6">
                    <h2 class="text-2xl font-bold mb-4" id="users-and-loans-summary-heading"></h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <button type="button" class="btn btn-primary" onclick="openModal('addUserModal')" id="add-new-user-btn"></button>
                        <button type="button" class="btn btn-primary" onclick="openModal('addContributionModal')" id="add-contribution-btn"></button>
                        <button type="button" class="btn btn-primary" onclick="openModal('addLoanModal')" id="add-new-loan-btn"></button>
                        <button type="button" class="btn btn-secondary" onclick="downloadUsersCsv()" id="download-users-csv-btn"></button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="user-table w-full text-sm">
                            <thead>
                                <tr>
                                    <th id="user-name-th"></th>
                                    <th id="monthly-contribution-status-th"></th>
                                    <th id="total-contribution-by-user-th"></th>
                                    <th id="pending-contribution-by-user-th"></th>
                                    <th id="pending-loan-amount-with-interest-th"></th>
                                    <th id="total-amount-paid-by-user-till-date-th"></th>
                                    <th id="loan-details-th"></th>
                                    <th id="actions-th"></th>
                                </tr>
                            </thead>
                            <tbody id="users-data-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="card mb-6" id="csv-bulk-uploads-section">
                    <h2 class="text-xl font-semibold mb-4" id="csv-bulk-uploads-heading">CSV Bulk Uploads</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2" id="bulk-upload-transactions-heading"></h3>
                        <form id="bulk-upload-transactions-form" class="space-y-4">
                            <label for="transaction_csv" class="block text-sm font-medium text-gray-700" id="choose-csv-file-transactions-label"></label>
                            <input type="file" name="file" id="transaction_csv" accept=".csv" class="form-control">
                            <button type="submit" class="btn btn-primary" id="upload-transactions-btn"></button>
                            <button type="button" class="btn btn-info" onclick="downloadSampleTransactionsCsv()" id="download-sample-transactions-btn"></button>
                        </form>
                    </div>

                    <div>
                        <h3 class="text-lg font-medium mb-2" id="bulk-upload-users-heading"></h3>
                        <form id="bulk-upload-users-form" class="space-y-4">
                            <label for="user_csv" class="block text-sm font-medium text-gray-700" id="choose-csv-file-users-label"></label>
                            <input type="file" name="file" id="user_csv" accept=".csv" class="form-control">
                            <button type="submit" class="btn btn-primary" id="upload-users-btn"></button>
                            <button type="button" class="btn btn-info" onclick="downloadSampleUsersCsv()" id="download-sample-users-btn"></button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="all-groups-report-content" style="display: none;">
                <div class="mb-4">
                    <button type="button" class="btn btn-secondary" onclick="showDashboard()" id="back-to-dashboard-btn-report"></button>
                </div>
                <div id="all-groups-report-cards">
                    </div>
            </div>

            <div id="view-transactions-content" style="display: none;">
                <header class="header">
                    <h1 class="text-3xl font-bold" id="view-transactions-header"></h1>
                    <h2 class="text-xl mt-2" id="view-transactions-user-name"></h2>
                </header>
                <div class="mb-6">
                    <button type="button" class="btn btn-secondary" onclick="showDashboard()" id="back-to-dashboard-btn-transactions"></button>
                </div>

                <div class="card mb-6">
                    <h3 class="text-xl font-semibold mb-4" id="filter-transactions-heading"></h3>
                    <form id="filter-transactions-form" class="flex flex-wrap items-end space-x-4">
                        <input type="hidden" id="filter-user-id">
                        <div class="form-group">
                            <label for="filter-from-date" class="block text-sm font-medium text-gray-700" id="from-date-label"></label>
                            <input type="date" id="filter-from-date" name="from_date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="filter-to-date" class="block text-sm font-medium text-gray-700" id="to-date-label"></label>
                            <input type="date" id="filter-to-date" name="to_date" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary" id="apply-filter-btn"></button>
                        <button type="button" class="btn btn-secondary" onclick="clearTransactionFilter()" id="clear-filter-btn"></button>
                    </form>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4" id="transaction-history-heading"></h3>
                    <div class="table-container">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th id="date-th"></th>
                                    <th id="type-th"></th>
                                    <th id="amount-th"></th>
                                    <th id="is-cash-payment-th"></th>
                                    <th id="is-paid-th"></th>
                                    <th id="loan-id-th"></th>
                                    <th id="new-loan-interest-rate-th"></th>
                                    <th id="description-th"></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-data-tbody">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-transactions-found" class="text-gray-600 mt-4" style="display: none;"></div>
                    <button type="button" class="btn btn-secondary mt-4" onclick="downloadTransactionsCsv()" id="download-transactions-csv-btn"></button>
                </div>
            </div>
        </div>


    </div>

    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addGroupModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-group-modal-heading"></h2>
            <form id="add-group-form" class="space-y-4">
                <div class="form-group">
                    <label for="group_name" id="group-name-label"></label>
                    <input type="text" id="group_name" name="group_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="bank_account_details" id="bank-account-details-label"></label>
                    <textarea id="bank_account_details" name="bank_account_details" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label for="default_interest_rate" id="default-interest-rate-label"></label>
                    <input type="number" step="0.01" id="default_interest_rate" name="default_interest_rate" class="form-control" value="12.0" required>
                </div>
                <div class="form-group">
                    <label for="bank_interest_rate" id="bank-interest-rate-label"></label>
                    <input type="number" step="0.01" id="bank_interest_rate" name="bank_interest_rate" class="form-control" value="3.0" required>
                </div>
                <button type="submit" class="btn btn-primary" id="add-group-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="updateBankRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('updateBankRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="edit-bank-interest-rate-modal-heading"></h2>
            <form id="update-bank-rate-form" class="space-y-4">
                <div class="form-group">
                    <label for="new_bank_interest_rate" id="new-interest-rate-label"></label>
                    <input type="number" step="0.01" id="new_bank_interest_rate" name="new_bank_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="update-bank-rate-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addUserModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-new-user-modal-heading"></h2>
            <form id="add-user-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_name_input" id="user-name-input-label"></label>
                    <input type="text" id="user_name_input" name="user_name" class="form-control" required>
                </div>
                <div class="form-group flex items-center space-x-2">
                    <input type="checkbox" id="is_admin" name="is_admin" class="form-checkbox h-4 w-4 text-green-600">
                    <label for="is_admin" class="text-gray-700" id="is-admin-label"></label>
                </div>
                <button type="submit" class="btn btn-primary" id="add-user-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addContributionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addContributionModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-contribution-modal-heading"></h2>
            <form id="add-contribution-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_id_contribution" id="user-name-contribution-label"></label>
                    <select id="user_id_contribution" name="user_id" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="amount_contribution" id="amount-label-contribution"></label>
                    <input type="number" step="0.01" id="amount_contribution" name="amount" class="form-control" required>
                </div>
                <div class="form-group flex items-center space-x-2">
                    <input type="checkbox" id="is_cash_payment_contribution" name="is_cash_payment" class="form-checkbox h-4 w-4 text-green-600">
                    <label for="is_cash_payment_contribution" class="text-gray-700" id="is-cash-payment-label-contribution"></label>
                </div>
                <button type="submit" class="btn btn-primary" id="add-contribution-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="markPaidModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('markPaidModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="mark-paid-modal-heading"></h2>
            <form id="markPaidForm" class="space-y-4">
                <input type="hidden" id="mark-paid-transaction-id">
                <p id="mark-paid-confirmation-text"></p>
                <button type="submit" class="btn btn-primary" id="mark-paid-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addLoanModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="add-new-loan-modal-heading"></h2>
            <form id="add-loan-form" class="space-y-4">
                <div class="form-group">
                    <label for="user_id_loan" id="user-name-loan-label"></label>
                    <select id="user_id_loan" name="user_id" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="loan_amount" id="loan-amount-label"></label>
                    <input type="number" step="0.01" id="loan_amount" name="loan_amount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loan_issue_date" id="loan-issue-date-label"></label>
                    <input type="date" id="loan_issue_date" name="loan_issue_date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loan_interest_rate" id="loan-interest-rate-label"></label>
                    <input type="number" step="0.01" id="loan_interest_rate" name="loan_interest_rate" class="form-control" value="12.0" required>
                </div>
                <button type="submit" class="btn btn-primary" id="add-loan-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="repayLoanModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('repayLoanModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="repay-loan-modal-heading"></h2>
            <form id="repay-loan-form" class="space-y-4">
                <input type="hidden" id="repay_loan_id">
                <p><b id="loan-id-display-label"></b> <span id="display_repay_loan_id"></span></p>
                <p><b id="outstanding-balance-display-label"></b> ₹<span id="display_outstanding_balance"></span></p>
                <p><b id="current-interest-rate-display-label"></b> <span id="display_current_interest_rate"></span>%</p>
                <p><b id="last-interest-calc-date-display-label"></b> <span id="display_last_interest_calc_date"></span></p>
                
                <div class="form-group">
                    <label for="repayment_amount" id="repayment-amount-label"></label>
                    <input type="number" step="0.01" id="repayment_amount" name="repayment_amount" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="repay-loan-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="changeInterestRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('changeInterestRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="change-interest-rate-modal-heading"></h2>
            <form id="change-interest-rate-form" class="space-y-4">
                <input type="hidden" id="change_rate_loan_id">
                <p><b id="loan-id-change-rate-label"></b> <span id="display_change_rate_loan_id"></span></p>
                <p><b id="current-rate-change-rate-label"></b> <span id="display_old_interest_rate"></span>%</p>
                <div class="form-group">
                    <label for="new_interest_rate_input" id="new-interest-rate-input-label"></label>
                    <input type="number" step="0.01" id="new_interest_rate_input" name="new_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="change-interest-rate-submit-btn"></button>
            </form>
        </div>
    </div>

    <div id="updateBankRateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('updateBankRateModal')">&times;</span>
            <h2 class="text-xl font-semibold mb-4" id="edit-bank-interest-rate-modal-heading-2"></h2>
            <form id="update-bank-rate-form-2" class="space-y-4">
                <div class="form-group">
                    <label for="new_bank_interest_rate_input_2" id="new-interest-rate-label-2"></label>
                    <input type="number" step="0.01" id="new_bank_interest_rate_input_2" name="new_bank_interest_rate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" id="update-bank-rate-submit-btn-2"></button>
            </form>
        </div>
    </div>


    <script>
        // --- GitHub Data Store Configuration ---
        const GITHUB_OWNER = 'pdek1991';
        const GITHUB_REPO = 'Ashtsheel_BachatGat';
        const GITHUB_DATA_BRANCH = 'data'; // The branch where your data files are stored
        const GITHUB_API_BASE_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/`;

        // !!! SECURITY WARNING: DO NOT USE THIS IN PRODUCTION !!!
        // This token will be publicly visible. For testing purposes only.
        // Replace 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN' with your actual GitHub PAT.
        const GITHUB_TOKEN = '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'; 

        let currentUserRole = null; // 'admin' or 'guest'

        // In-memory cache for data to reduce GitHub API calls
        let groupData = [];
        let userData = [];
        let transactionData = [];
        let loanData = [];

        const MARATHI_LABELS = {
            'app_name': 'अष्टशील महिला बचत गट',
            'select_group': 'गट निवडा',
            'add_group': 'नवीन गट जोडा',
            'group_name': 'गटाचे नाव',
            'bank_account_details': 'बँक खात्याचा तपशील',
            'default_interest_rate': 'कर्जावरील पूर्वनिर्धारित व्याज दर (%)',
            'add': 'जोडा',
            'group_financial_summary': 'गटाचा आर्थिक सारांश',
            'overall_summary': 'एकूण नफा',
            'total_contributions': 'एकूण योगदान',
            'total_loans_disbursed': 'वितरित एकूण कर्ज',
            'total_loan_repayments': 'एकूण कर्ज परतफेड',
            'total_interest_received': 'मिळालेले एकूण व्याज',
            'overall_profit': 'एकूण नफा',
            'monthly_profit': 'मासिक नफा (या महिन्याचा)',
            'yearly_profit': 'वार्षिक नफा (या वर्षाचा)',
            'monthly_investment': 'मासिक गुंतवणूक (या महिन्याची)',
            'yearly_investment': 'वार्षिक गुंतवणूक (या वर्षाची)',
            'group_profit_label': 'गट नफा',
            'users_and_loans_summary': 'सदस्य आणि कर्जाचा सारांश',
            'user_name': 'सदस्य नाव',
            'loan_amount_outstanding': 'थकबाकी कर्ज रक्कम',
            'interest_paid': 'व्याज भरले',
            'remaining_loan_amount_with_interest': 'व्याजसह उर्वरित कर्ज रक्कम',
            'monthly_contribution_status': 'मासिक योगदान स्थिती',
            'active': 'सक्रिय',
            'inactive': 'निष्क्रिय',
            'add_new_user': 'नवीन सदस्य जोडा',
            'user_name_input': 'सदस्य नाव',
            'is_admin': 'प्रशासक आहे का?',
            'toggle_status': 'स्थिती बदला',
            'add_contribution': 'योगदान जोडा',
            'amount': 'रक्कम',
            'is_cash_payment': 'रोख भरणा आहे का?',
            'mark_paid': 'भरणा झाला म्हणून चिन्हांकित करा',
            'add_new_loan': 'नवीन कर्ज जोडा',
            'loan_amount': 'कर्ज रक्कम',
            'loan_issue_date': 'कर्ज दिल्याची तारीख',
            'loan_interest_rate': 'कर्जावरील व्याज दर (%)',
            'repay_loan': 'कर्ज परतफेड करा',
            'repayment_amount': 'परतफेड रक्कम',
            'change_interest_rate': 'व्याज दर बदला',
            'new_interest_rate': 'नवीन व्याज दर (%)',
            'loan_id': 'कर्ज आयडी',
            'status_active': 'सक्रिय',
            'status_paid_off': 'कर्ज फेडले',
            'status_pending_cash_payment': 'रोख भरणा बाकी',
            'bulk_upload_transactions': 'बल्क व्यवहार अपलोड करा',
            'bulk_upload_users': 'बल्क सदस्य अपलोड करा',
            'download_sample_transactions': 'व्यवहार नमुना CSV डाउनलोड करा',
            'download_sample_users': 'सदस्य नमुना CSV डाउनलोड करा',
            'choose_csv_file': 'CSV फाइल निवडा',
            'upload': 'अपलोड करा',
            'no_file_part': 'फाइलचा भाग नाही',
            'no_selected_file': 'कोणतीही फाइल निवडली नाही',
            'invalid_file_type': 'चुकीचा फाइल प्रकार. कृपया CSV फाइल अपलोड करा.',
            'upload_complete': 'बल्क अपलोड पूर्ण झाले. {processed_count} व्यवहार यशस्वीरित्या प्रक्रिया केले, {error_count} त्रुटी.',
            'upload_error': 'बल्क अपलोड दरम्यान त्रुटी: {error}',
            'user_not_found_in_group': "गट '{group_name}' मध्ये सदस्य '{user_name}' सापडला नाही.",
            'unknown_transaction_type': "अज्ञात व्यवहार प्रकार '{transaction_type}'",
            'data_conversion_error': "डेटा रूपांतरण त्रुटी: {error}",
            'error_processing_row': "पंक्ती प्रक्रिया करताना त्रुटी: {error}",
            'loan_id_missing': "कर्ज परतफेडीसाठी 'loan_id' आवश्यक आहे.",
            'loan_not_found': "कर्ज आयडी {loan_id} या सदस्यासाठी या गटात सापडला नाही.",
            'loan_already_paid_off': "हे कर्ज आधीच फेडले गेले आहे.",
            'loan_id_not_for_new_loan': "'loan_disbursement' साठी 'loan_id' देऊ नये.",
            'invalid_interest_rate': "नवीन कर्जासाठी व्याज दर '{rate}' अवैध आहे. तो 0 आणि 100 च्या दरम्यान असावा.",
            'group_added_success': 'गट यशस्वीरित्या जोडला!',
            'group_exists_error': 'त्रुटी: या नावाने गट आधीच अस्तित्वात आहे.',
            'interest_rate_number_error': 'त्रुटी: पूर्वनिर्धारित व्याज दर एक संख्या असणे आवश्यक आहे.',
            'error_adding_group': 'गट जोडताना त्रुटी: {error}',
            'user_added_success': 'सदस्य "{name}" यशस्वीरित्या जोडला!',
            'error_adding_user': 'सदस्य जोडताना त्रुटी: {error}',
            'unauthorized_access': 'अनधिकृत प्रवेश.', // Not directly applicable in client-side, but kept for consistency
            'user_status_changed': 'सदस्य स्थिती "{status}" मध्ये बदलली.',
            'user_not_found': 'सदस्य सापडला नाही.',
            'contribution_added_success': '₹{amount:.2f} चे योगदान {user_name} साठी जोडले. स्थिती: {status}.',
            'pending_cash_payment': 'रोख भरणा बाकी',
            'paid_upi_bank': 'भरले (UPI/बँक)',
            'error_adding_contribution': 'योगदान जोडताना त्रुटी: {error}',
            'cash_payment_marked_paid': 'रोख भरणा भरले म्हणून चिन्हांकित केला.',
            'payment_already_paid': 'भरणा आधीच भरले म्हणून चिन्हांकित केला आहे.',
            'transaction_not_found': 'व्यवहार सापडला नाही किंवा प्रलंबित रोख भरणा नाही.',
            'invalid_user_or_group': 'अवैध सदस्य आयडी किंवा सदस्य निर्दिष्ट गटाशी संबंधित नाही.',
            'invalid_group_id': 'अवैध गट आयडी.',
            'loan_amount_positive_error': 'कर्ज रक्कम सकारात्मक असणे आवश्यक आहे.',
            'interest_rate_range_error': 'व्याज दर 0 आणि 100 च्या दरम्यान असणे आवश्यक आहे.',
            'loan_disbursed_success': 'कर्ज आयडी {loan_id} ची ₹{amount:.2f} रक्कम {user_name} ला {rate}% वार्षिक व्याजाने वितरित केली.',
            'input_error': 'इनपुट त्रुटी: {error}',
            'error_adding_loan': 'कर्ज जोडताना त्रुटी: {error}',
            'loan_rate_changed_success': 'कर्ज आयडी {loan_id} साठी व्याज दर {old_rate}% वरून {new_rate}% मध्ये बदलला.',
            'error_changing_loan_rate': 'व्याज दर बदलताना त्रुटी: {error}',
            'repayment_amount_positive_error': 'परतफेड रक्कम सकारात्मक असणे आवश्यक आहे.',
            'loan_repayment_processed_success': 'कर्ज परतफेड ₹{repayment_amount:.2f} कर्ज आयडी {loan_id} साठी प्रक्रिया केली. ' + 'मूळ रक्कम ₹{actual_principal_repaid:.2f} नी कमी झाली, व्याजाचा भाग: ₹{interest_paid_amount:.2f}. ' + 'उर्वरित शिल्लक: ₹{new_outstanding_balance:.2f}.',
            'loan_fully_paid_off': 'कर्ज आयडी {loan_id} पूर्णपणे फेडले गेले आहे!',
            'error_repaying_loan': 'कर्ज परतफेड प्रक्रिया करताना त्रुटी: {error}',
            'user_exists_in_group': "पंक्ती {row_num}: सदस्य '{user_name}' गट आयडी {target_group_id} मध्ये आधीच अस्तित्वात आहे.",
            'user_added_to_group': "पंक्ती {row_num}: सदस्य '{user_name}' गट आयडी {target_group_id} मध्ये जोडला.",
            'group_not_found': "पंक्ती {row_num}: गट '{group_identifier}' सापडला नाही.",
            'missing_user_or_group': "पंक्ती {row_num}: पंक्ती वगळत आहे: 'user_name' किंवा 'group_id'/'group_name' गहाळ आहे.",
            'confirm_duplicates_title': 'दुबार व्यवहार आढळले', // Not used in client-side
            'confirm_duplicates_message': 'या फाइलमध्ये एकाच सदस्यासाठी एकापेक्षा जास्त व्यवहार (योगदान किंवा परतफेड) आहेत. तुम्हाला हे व्यवहार स्वीकारायचे आहेत का?', // Not used in client-side
            'duplicate_details': 'दुबार व्यवहाराचा तपशील:', // Not used in client-side
            'transaction_type': 'व्यवहाराचा प्रकार',
            'transaction_amount': 'रक्कम',
            'transaction_date': 'तारीख',
            'accept_all_duplicates': 'सर्व दुबार व्यवहार स्वीकारा', // Not used in client-side
            'reject_duplicates': 'दुबार व्यवहार नाकारा', // Not used in client-side
            'duplicate_transactions_rejected': 'दुबार व्यवहार नाकारले गेले. कोणतीही नवीन व्यवहार जोडली नाही.', // Not used in client-side
            'processing_duplicates_accepted': 'दुबार व्यवहार स्वीकारले गेले. प्रक्रिया सुरू आहे...', // Not used in client-side
            'processing_duplicates_rejected': 'दुबार व्यवहार नाकारले गेले.', // Not used in client-side
            'please_select_group': 'कृपया गट निवडा',
            'view_all_transactions': 'सर्व व्यवहार पहा',
            'back_to_summary': 'सारांशाकडे परत',
            'filter_transactions': 'व्यवहार फिल्टर करा',
            'from_date': 'पासूनची तारीख',
            'to_date': 'पर्यंतची तारीख',
            'filter': 'फिल्टर करा',
            'all_transactions_for': '{user_name} चे सर्व व्यवहार',
            'description': 'वर्णन',
            'download_transactions_csv': 'व्यवहार CSV डाउनलोड करा',
            'download_users_csv': 'सदस्य CSV डाउनलोड करा',
            'total_transactions': 'एकूण व्यवहार',
            'total_loans': 'एकूण कर्ज',
            'current_loan_status': 'चालू कर्ज स्थिती',
            'original_amount': 'मूळ रक्कम',
            'outstanding_balance': 'थकबाकी शिल्लक',
            'interest_rate': 'व्याज दर',
            'issue_date': 'दिलेली तारीख',
            'last_interest_calc_date': 'शेवटची व्याज गणना तारीख',
            'status': 'स्थिती',
            'view_details': 'तपशील पहा',
            'total_pending_cash_payments': 'प्रलंबित रोख भरणा',
            'total_contribution_by_user': 'एकूण योगदान',
            'pending_contribution_by_user': 'प्रलंबित योगदान',
            'total_loans_disbursed_to_user': 'एकूण वितरित कर्ज',
            'pending_loan_amount_with_interest': 'प्रलंबित कर्ज (व्याजासह)',
            'users_with_active_loans': 'सक्रिय कर्ज असलेले सदस्य',
            'users_without_active_loans': 'सक्रिय कर्ज नसलेले सदस्य',
            'total_amount_paid_by_user_till_date': 'सदस्याने आजपर्यंत भरलेली एकूण रक्कम',
            'bank_interest_rate': 'बँक व्याज दर',
            'saving_account_balance': 'बचत खाते शिल्लक',
            'edit_bank_interest_rate': 'बँक व्याज दर संपादित करा',
            'update': 'अद्यतनित करा',
            'bank_interest_rate_updated_success': 'बँक व्याज दर यशस्वीरित्या अद्यतनित केला.',
            'error_updating_bank_interest_rate': 'बँक व्याज दर अद्यतनित करताना त्रुटी: {error}',
            'all_users_summary': 'सर्व सदस्यांचा सारांश',
            'view_all_groups_report': 'सर्व गटांचा अहवाल पहा',
            'all_groups_report': 'सर्व गटांचा अहवाल',
            'group_name_report': 'गटाचे नाव',
            'pending_contributions_report': 'प्रलंबित योगदान',
            'total_outstanding_loans_report': 'एकूण थकबाकी कर्ज',
            'total_paid_contributions_report': 'एकूण भरलेले योगदान',
            'total_bank_interest_report': 'एकूण बँक व्याज',
            'net_profit_report': 'निव्वळ नफा',
            'loading_data': 'डेटा लोड होत आहे...',
            'processing': 'प्रक्रिया करत आहे...',
            'delete': 'हटवा',
            'edit': 'संपादित करा',
            'yes': 'होय',
            'no': 'नाही',
            'paid': 'भरले',
            'apply_filter': 'फिल्टर लागू करा',
            'clear_filter': 'फिल्टर साफ करा',
            'transaction_history': 'व्यवहार इतिहास',
            'no_transactions_found': 'कोणतेही व्यवहार आढळले नाहीत.',
            'loan_details': 'कर्जाचा तपशील',
            'no_active_loans': 'सक्रिय कर्ज नाही',
            'actions': 'क्रिया',
            'login_success_admin': 'प्रशासक म्हणून यशस्वीरित्या लॉग इन केले!',
            'login_success_guest': 'अतिथी म्हणून यशस्वीरित्या लॉग इन केले!',
            'login_failed': 'अवैध वापरकर्तानाव किंवा पासवर्ड.',
            'logout_success': 'यशस्वीरित्या लॉग आउट केले.',
            'logged_in_as': 'म्हणून लॉग इन केले आहे: {role}',
            'not_logged_in': 'लॉग इन केलेले नाही',
            'mark_paid_confirmation_text': 'तुम्हाला खात्री आहे की तुम्हाला हा रोख भरणा भरले म्हणून चिन्हांकित करायचा आहे?',
            'no_groups_found_to_generate_report': 'अहवाल तयार करण्यासाठी कोणताही गट आढळला नाही.',
            'no_loans_found': 'कोणतेही कर्ज आढळले नाही.',
            'no_user_selected': 'कोणताही सदस्य निवडलेला नाही.',
            'success': 'यशस्वी',
            'error_fetching_data': 'डेटा मिळवताना त्रुटी: {error}',
            'error_updating_data': 'डेटा अद्यतनित करताना त्रुटी: {error}',
            'error_adding_data': 'डेटा जोडताना त्रुटी: {error}',
            'error_deleting_data': 'डेटा हटवताना त्रुटी: {error}',
            'data_not_found': 'डेटा सापडला नाही.',
            'invalid_data_format': 'अवैध डेटा स्वरूप.',
            'id_missing': 'आयडी गहाळ आहे.',
            'group_data_error': 'गट डेटा प्रक्रिया करताना त्रुटी.',
            'user_data_error': 'सदस्य डेटा प्रक्रिया करताना त्रुटी.',
            'transaction_data_error': 'व्यवहार डेटा प्रक्रिया करताना त्रुटी.',
            'loan_data_error': 'कर्ज डेटा प्रक्रिया करताना त्रुटी.'
        };

        let currentActiveTab = 'dashboard';
        let currentUserId = null; // To store the user ID for transaction history view
        let selectedGroupId = null; // To store the currently selected group ID

        // --- GitHub API Helper Functions ---

        /**
         * Generates a simple unique ID.
         * Note: For concurrent multi-user writes, a more robust UUID generation strategy
         * or server-side ID generation is recommended to prevent collisions.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        /**
         * Fetches content of a file from GitHub and returns its content (parsed JSON) and SHA.
         * @param {string} filePath - Path to the file relative to the data branch (e.g., 'groups.json').
         * @returns {Promise<{content: Array<Object>, sha: string}|null>} - Parsed JSON content and SHA, or null if file not found.
         */
        async function _fetchGitHubFile(filePath) {
            const url = `${GITHUB_API_BASE_URL}${GITHUB_DATA_BRANCH}/${filePath}?ref=${GITHUB_DATA_BRANCH}`;
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json' // Request JSON metadata to get SHA
                    }
                });

                if (response.status === 404) {
                    console.warn(`File ${filePath} not found on GitHub. Assuming empty or creating.`);
                    return { content: [], sha: null }; // Indicate new file scenario
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API Error fetching ${filePath}: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                // GitHub API returns content base64 encoded for files. Decode it.
                const decodedContent = JSON.parse(atob(data.content));
                return { content: decodedContent, sha: data.sha };

            } catch (error) {
                console.error(`Error in _fetchGitHubFile(${filePath}):`, error);
                throw error; // Re-throw to be caught by calling functions
            }
        }

        /**
         * Updates content of a file on GitHub.
         * @param {string} filePath - Path to the file relative to the data branch (e.g., 'groups.json').
         * @param {Array<Object>} newContent - The new JSON content to write.
         * @param {string|null} currentSha - The SHA of the current file. Required for updates, null for creation.
         * @returns {Promise<boolean>} - True if successful, false otherwise.
         */
        async function _updateGitHubFile(filePath, newContent, currentSha) {
            const url = `${GITHUB_API_BASE_URL}${GITHUB_DATA_BRANCH}/${filePath}`;
            const encodedContent = btoa(JSON.stringify(newContent, null, 2)); // Base64 encode content, pretty print for readability

            const body = {
                message: `Update ${filePath} from app`,
                content: encodedContent,
                sha: currentSha, // Required for updates
                branch: GITHUB_DATA_BRANCH
            };

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json',
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API Error updating ${filePath}: ${response.status} - ${errorData.message || JSON.stringify(errorData)}`);
                }
                return true;
            } catch (error) {
                console.error(`Error in _updateGitHubFile(${filePath}):`, error);
                throw error; // Re-throw to be caught by calling functions
            }
        }

        // --- Data Persistence Layer (Replacing IndexedDB functions) ---

        /**
         * Initializes the data store. For GitHub, this means loading all data into memory.
         */
        async function openDB() {
            // No IndexedDB to open, just load data into memory from GitHub
            await loadInitialData();
            console.log("GitHub data store initialized and data loaded into memory.");
        }

        /**
         * Loads all data from GitHub into the in-memory caches.
         */
        async function loadInitialData() {
            try {
                groupData = await getAllData('groups');
                userData = await getAllData('users');
                transactionData = await getAllData('transactions');
                loanData = await getAllData('loans');
            } catch (error) {
                console.error("Error loading initial data from GitHub:", error);
                flashMessage(getMarathiLabel('error_fetching_data', { error: error.message }), 'danger');
            }
        }

        /**
         * Adds a new item to a data store and persists it to GitHub.
         * @param {string} storeName - The name of the data store (e.g., 'groups', 'users').
         * @param {Object} newItem - The item to add.
         * @returns {Promise<string>} - The ID of the newly added item.
         */
        async function addData(storeName, newItem) {
            try {
                const filePath = `${storeName}.json`;
                const { content: currentData, sha: currentSha } = await _fetchGitHubFile(filePath);

                if (!newItem.id) {
                    newItem.id = generateUniqueId();
                }

                currentData.push(newItem);
                const success = await _updateGitHubFile(filePath, currentData, currentSha);
                if (success) {
                    // Update in-memory cache
                    switch (storeName) {
                        case 'groups': groupData.push(newItem); break;
                        case 'users': userData.push(newItem); break;
                        case 'transactions': transactionData.push(newItem); break;
                        case 'loans': loanData.push(newItem); break;
                    }
                    return newItem.id;
                } else {
                    throw new Error('Failed to add data to GitHub.');
                }
            } catch (error) {
                console.error(`Error in addData(${storeName}):`, error);
                flashMessage(getMarathiLabel('error_adding_data', { error: error.message }), 'danger');
                throw error;
            }
        }

        /**
         * Retrieves all items from a data store. Primarily returns from in-memory cache.
         * @param {string} storeName - The name of the data store.
         * @returns {Array<Object>} - An array of items.
         */
        async function getAllData(storeName) {
            // For getAllData, we return from the in-memory cache which is updated by writes
            // and refreshed on initial load. If a full refresh is needed, call loadInitialData() first.
            switch (storeName) {
                case 'groups': return groupData;
                case 'users': return userData;
                case 'transactions': return transactionData;
                case 'loans': return loanData;
                default: return [];
            }
        }

        /**
         * Retrieves a single item by its ID from a data store. Uses in-memory cache.
         * @param {string} storeName - The name of the data store.
         * @param {string} id - The ID of the item.
         * @returns {Object|undefined} - The item, or undefined if not found.
         */
        async function getDataById(storeName, id) {
            const data = await getAllData(storeName); // Get from in-memory cache
            return data.find(item => item.id === id);
        }

        /**
         * Updates an existing item in a data store and persists it to GitHub.
         * @param {string} storeName - The name of the data store.
         * @param {Object} updatedItem - The item with updated data (must contain 'id').
         */
        async function updateData(storeName, updatedItem) {
            try {
                const filePath = `${storeName}.json`;
                const { content: currentData, sha: currentSha } = await _fetchGitHubFile(filePath);

                const index = currentData.findIndex(item => item.id === updatedItem.id);
                if (index === -1) {
                    throw new Error(getMarathiLabel('data_not_found', { storeName: storeName, id: updatedItem.id }));
                }

                currentData[index] = { ...currentData[index], ...updatedItem };
                const success = await _updateGitHubFile(filePath, currentData, currentSha);
                if (success) {
                    // Update in-memory cache
                    switch (storeName) {
                        case 'groups': groupData[groupData.findIndex(item => item.id === updatedItem.id)] = updatedItem; break;
                        case 'users': userData[userData.findIndex(item => item.id === updatedItem.id)] = updatedItem; break;
                        case 'transactions': transactionData[transactionData.findIndex(item => item.id === updatedItem.id)] = updatedItem; break;
                        case 'loans': loanData[loanData.findIndex(item => item.id === updatedItem.id)] = updatedItem; break;
                    }
                } else {
                    throw new Error('Failed to update data on GitHub.');
                }
            } catch (error) {
                console.error(`Error in updateData(${storeName}):`, error);
                flashMessage(getMarathiLabel('error_updating_data', { error: error.message }), 'danger');
                throw error;
            }
        }

        /**
         * Deletes an item from a data store and persists the change to GitHub.
         * @param {string} storeName - The name of the data store.
         * @param {string} id - The ID of the item to delete.
         */
        async function deleteData(storeName, id) {
            try {
                const filePath = `${storeName}.json`;
                const { content: currentData, sha: currentSha } = await _fetchGitHubFile(filePath);

                const initialLength = currentData.length;
                const newData = currentData.filter(item => item.id !== id);

                if (newData.length === initialLength) {
                    throw new Error(getMarathiLabel('data_not_found', { storeName: storeName, id: id }));
                }

                const success = await _updateGitHubFile(filePath, newData, currentSha);
                if (success) {
                    // Update in-memory cache
                    switch (storeName) {
                        case 'groups': groupData = groupData.filter(item => item.id !== id); break;
                        case 'users': userData = userData.filter(item => item.id !== id); break;
                        case 'transactions': transactionData = transactionData.filter(item => item.id !== id); break;
                        case 'loans': loanData = loanData.filter(item => item.id !== id); break;
                    }
                } else {
                    throw new Error('Failed to delete data from GitHub.');
                }
            } catch (error) {
                console.error(`Error in deleteData(${storeName}):`, error);
                flashMessage(getMarathiLabel('error_deleting_data', { error: error.message }), 'danger');
                throw error;
            }
        }


        // --- Existing Application Logic (mostly unchanged, will now use GitHub data functions) ---

        // Utility function to display flash messages
        function flashMessage(message, type) {
            const flashMessagesDiv = document.getElementById('flash-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flash-message flash-${type}`;
            messageDiv.textContent = message;
            flashMessagesDiv.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Utility to get Marathi labels
        function getMarathiLabel(key, replacements = {}) {
            let label = MARATHI_LABELS[key] || key;
            for (const placeholder in replacements) {
                label = label.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            return label;
        }

        // Modals management
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // User authentication (remains client-side for this example)
        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Simple client-side authentication for demonstration
            if (username === 'admin' && password === 'admin') {
                currentUserRole = 'admin';
                flashMessage(getMarathiLabel('login_success_admin'), 'success');
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('auth-status').textContent = `${getMarathiLabel('logged_in_as', { role: 'Admin' })}`;
                document.getElementById('logout-btn').classList.remove('hidden');
                await initApp();
            } else if (username === 'guest' && password === 'guest') {
                currentUserRole = 'guest';
                flashMessage(getMarathiLabel('login_success_guest'), 'success');
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('auth-status').textContent = `${getMarathiLabel('logged_in_as', { role: 'Guest' })}`;
                document.getElementById('logout-btn').classList.remove('hidden');
                await initApp();
            } else {
                flashMessage(getMarathiLabel('login_failed'), 'danger');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', function() {
            currentUserRole = null;
            selectedGroupId = null; // Clear selected group on logout
            flashMessage(getMarathiLabel('logout_success'), 'info');
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('auth-status').textContent = getMarathiLabel('not_logged_in');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'none';
            document.getElementById('groupSelect').innerHTML = ''; // Clear group select
        });

        // Initialize App and load data
        async function initApp() {
            await openDB(); // This now loads data from GitHub into memory
            await populateGroupSelect();
            // Try to restore last selected group
            const storedGroupId = localStorage.getItem('selectedGroupId');
            if (storedGroupId && groupData.some(g => g.id === storedGroupId)) {
                selectedGroupId = storedGroupId;
                document.getElementById('groupSelect').value = selectedGroupId;
                await loadGroupDashboard(selectedGroupId);
            }
        }

        async function populateGroupSelect() {
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.innerHTML = '<option value="">' + getMarathiLabel('please_select_group') + '</option>';
            // groupData is already loaded by openDB/loadInitialData
            groupData.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });

            // Set the previously selected group if it exists
            if (selectedGroupId && groupData.some(g => g.id === selectedGroupId)) {
                groupSelect.value = selectedGroupId;
            }
        }

        document.getElementById('groupSelect').addEventListener('change', async function() {
            selectedGroupId = this.value;
            localStorage.setItem('selectedGroupId', selectedGroupId); // Save selected group
            if (selectedGroupId) {
                await loadGroupDashboard(selectedGroupId);
                document.getElementById('dashboard-content').style.display = 'block';
                document.getElementById('all-groups-report-content').style.display = 'none';
            } else {
                document.getElementById('dashboard-content').style.display = 'none';
            }
        });

        async function loadGroupDashboard(groupId) {
            if (!groupId) return;
            const group = groupData.find(g => g.id === groupId);
            if (!group) {
                flashMessage(getMarathiLabel('group_not_found', { group_identifier: groupId }), 'danger');
                return;
            }

            document.getElementById('group-financial-summary-heading').textContent = `${group.name} - ${getMarathiLabel('group_financial_summary')}`;
            
            // Re-fetch all data to ensure the local cache is fresh before calculations
            // This is important after any write operations from other clients or bulk uploads.
            await loadInitialData(); 
            
            updateGroupSummaryReports(group);
            await populateUsersTable(groupId);
            
            // Show/hide admin-specific sections
            if (currentUserRole === 'admin') {
                document.getElementById('csv-bulk-uploads-section').style.display = 'block';
                document.getElementById('add-group-btn').style.display = 'inline-block';
                document.getElementById('add-new-user-btn').style.display = 'inline-block';
                document.getElementById('add-contribution-btn').style.display = 'inline-block';
                document.getElementById('add-new-loan-btn').style.display = 'inline-block';
                document.getElementById('download-users-csv-btn').style.display = 'inline-block';
            } else {
                document.getElementById('csv-bulk-uploads-section').style.display = 'none';
                document.getElementById('add-group-btn').style.display = 'none';
                document.getElementById('add-new-user-btn').style.display = 'none';
                document.getElementById('add-contribution-btn').style.display = 'none';
                document.getElementById('add-new-loan-btn').style.display = 'none';
                document.getElementById('download-users-csv-btn').style.display = 'none';
            }
        }

        function updateGroupSummaryReports(group) {
            const reportsDiv = document.getElementById('group-summary-reports');
            reportsDiv.innerHTML = '';

            const currentGroupUsers = userData.filter(u => u.group_id === group.id);
            const currentGroupTransactions = transactionData.filter(t => currentGroupUsers.some(u => u.id === t.user_id));
            const currentGroupLoans = loanData.filter(l => currentGroupUsers.some(u => u.id === l.user_id));

            const totalContributions = currentGroupTransactions
                .filter(t => t.type === 'contribution' && t.is_paid === true)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalLoansDisbursed = currentGroupTransactions
                .filter(t => t.type === 'loan_disbursement')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalLoanRepayments = currentGroupTransactions
                .filter(t => t.type === 'loan_repayment' && t.is_paid === true)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);

            const totalInterestReceived = currentGroupTransactions
                .filter(t => t.type === 'interest_paid') // Assuming 'interest_paid' is a transaction type
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Calculate total outstanding loans (principal only)
            const totalOutstandingLoans = currentGroupLoans.reduce((sum, loan) => {
                if (loan.status === 'active') {
                    const accruedInterest = calculateInterest(
                        parseFloat(loan.outstanding_balance),
                        parseFloat(loan.interest_rate),
                        loan.last_interest_calc_date || loan.issue_date
                    );
                    return sum + parseFloat(loan.outstanding_balance) + accruedInterest;
                }
                return sum;
            }, 0);

            // Calculate pending cash payments
            const pendingCashPayments = currentGroupTransactions
                .filter(t => t.is_cash_payment && t.is_paid === false)
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Calculate overall profit/fund balance
            // This is a simplified profit calculation. In a real scenario, this would be more complex.
            const overallProfit = totalInterestReceived; // Overall profit is primarily interest received

            const bankInterestEarned = group.bank_interest_rate ? calculateBankInterest(totalContributions, group.bank_interest_rate) : 0;
            const savingAccountBalance = (totalContributions + totalLoanRepayments + totalInterestReceived + bankInterestEarned) - totalLoansDisbursed;
            
            const reports = [
                { label: getMarathiLabel('overall_profit'), value: overallProfit.toFixed(2), type: 'profit' },
                { label: getMarathiLabel('total_contributions'), value: totalContributions.toFixed(2), type: '' },
                { label: getMarathiLabel('total_loans_disbursed'), value: totalLoansDisbursed.toFixed(2), type: 'loan' },
                { label: getMarathiLabel('total_loan_repayments'), value: totalLoanRepayments.toFixed(2), type: '' },
                { label: getMarathiLabel('total_interest_received'), value: totalInterestReceived.toFixed(2), type: 'profit' },
                { label: getMarathiLabel('total_outstanding_loans_report'), value: totalOutstandingLoans.toFixed(2), type: 'loan' },
                { label: getMarathiLabel('total_pending_cash_payments'), value: pendingCashPayments.toFixed(2), type: 'loan' },
                { label: getMarathiLabel('bank_interest_rate'), value: `${parseFloat(group.bank_interest_rate || 0).toFixed(2)}%`, type: '' },
                { label: getMarathiLabel('saving_account_balance'), value: savingAccountBalance.toFixed(2), type: 'profit' }
            ];

            reports.forEach(report => {
                const widget = document.createElement('div');
                widget.className = `report-widget ${report.type}`;
                widget.innerHTML = `<h3 class="text-lg font-semibold">${report.label}</h3><p class="text-3xl font-bold">₹${report.value}</p>`;
                reportsDiv.appendChild(widget);
            });

            if (currentUserRole === 'admin') {
                 // Add edit bank rate button if admin
                 const editBtn = document.createElement('button');
                 editBtn.className = 'btn btn-info mt-4';
                 editBtn.textContent = getMarathiLabel('edit_bank_interest_rate');
                 editBtn.onclick = () => openUpdateBankRateModal(group.id, group.bank_interest_rate || 0);
                 reportsDiv.appendChild(editBtn);
            }
        }

        async function populateUsersTable(groupId) {
            const usersDataTbody = document.getElementById('users-data-tbody');
            usersDataTbody.innerHTML = '';
            
            // Ensure latest data is used
            await loadInitialData(); 
            
            const groupUsers = userData.filter(user => user.group_id === groupId);

            document.getElementById('user-name-th').textContent = getMarathiLabel('user_name');
            document.getElementById('monthly-contribution-status-th').textContent = getMarathiLabel('monthly_contribution_status');
            document.getElementById('total-contribution-by-user-th').textContent = getMarathiLabel('total_contribution_by_user');
            document.getElementById('pending-contribution-by-user-th').textContent = getMarathiLabel('pending_contribution_by_user');
            document.getElementById('pending-loan-amount-with-interest-th').textContent = getMarathiLabel('pending_loan_amount_with_interest');
            document.getElementById('total-amount-paid-by-user-till-date-th').textContent = getMarathiLabel('total_amount_paid_by_user_till_date');
            document.getElementById('loan-details-th').textContent = getMarathiLabel('loan_details');
            document.getElementById('actions-th').textContent = getMarathiLabel('actions');

            // Populate user select dropdowns in modals
            const userSelectContribution = document.getElementById('user_id_contribution');
            const userSelectLoan = document.getElementById('user_id_loan');
            userSelectContribution.innerHTML = `<option value="">-- ${getMarathiLabel('select_group')} --</option>`; // Placeholder
            userSelectLoan.innerHTML = `<option value="">-- ${getMarathiLabel('select_group')} --</option>`; // Placeholder


            for (const user of groupUsers) {
                const userTransactions = transactionData.filter(t => t.user_id === user.id);
                const userLoans = loanData.filter(l => l.user_id === user.id);

                const totalContributions = userTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const pendingContributions = userTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === false)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                let pendingLoanAmountWithInterest = 0;
                let totalAmountPaidByUserTillDate = 0; // Contributions + loan repayments (principal + interest)

                const activeLoans = userLoans.filter(loan => loan.status === 'active');
                for (const loan of activeLoans) {
                    const calculatedInterest = calculateInterest(parseFloat(loan.outstanding_balance), parseFloat(loan.interest_rate), loan.last_interest_calc_date || loan.issue_date);
                    pendingLoanAmountWithInterest += parseFloat(loan.outstanding_balance) + calculatedInterest;
                }

                totalAmountPaidByUserTillDate = totalContributions + userTransactions
                    .filter(t => t.type === 'loan_repayment' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                // For monthly contribution status, check if any contribution was made this month
                const currentMonth = new Date().toISOString().slice(0, 7);
                const monthlyContributionStatus = userTransactions.some(t => 
                    t.type === 'contribution' && t.is_paid === true && t.date.startsWith(currentMonth)
                ) ? 'received' : 'not_received';
                const monthlyStatusText = monthlyContributionStatus === 'received' ? getMarathiLabel('received') : getMarathiLabel('not_received'); // Assuming 'received' and 'not_received' labels exist
                const monthlyStatusClass = monthlyContributionStatus === 'received' ? 'status-received' : 'status-pending';


                const row = usersDataTbody.insertRow();
                row.insertCell().textContent = user.name;
                row.insertCell().innerHTML = `<span class="${monthlyStatusClass}">${monthlyStatusText}</span>`;
                row.insertCell().textContent = totalContributions.toFixed(2);
                row.insertCell().textContent = pendingContributions.toFixed(2);
                row.insertCell().textContent = pendingLoanAmountWithInterest.toFixed(2);
                row.insertCell().textContent = totalAmountPaidByUserTillDate.toFixed(2);

                // Loan Details Cell
                const loanDetailsCell = row.insertCell();
                if (userLoans.length > 0) {
                    const loanList = document.createElement('ul');
                    userLoans.forEach(loan => {
                        const li = document.createElement('li');
                        const statusText = loan.status === 'active' ? getMarathiLabel('status_active') : getMarathiLabel('status_paid_off');
                        li.innerHTML = `<b>${getMarathiLabel('loan_id')}:</b> ${loan.id}<br>` +
                                       `<b>${getMarathiLabel('original_amount')}:</b> ₹${parseFloat(loan.original_amount).toFixed(2)}<br>` +
                                       `<b>${getMarathiLabel('outstanding_balance')}:</b> ₹${parseFloat(loan.outstanding_balance).toFixed(2)}<br>` +
                                       `<b>${getMarathiLabel('interest_rate')}:</b> ${parseFloat(loan.interest_rate).toFixed(2)}%<br>` +
                                       `<b>${getMarathiLabel('issue_date')}:</b> ${formatDate(loan.issue_date)}<br>` +
                                       `<b>${getMarathiLabel('last_interest_calc_date')}:</b> ${loan.last_interest_calc_date ? formatDate(loan.last_interest_calc_date) : 'N/A'}<br>` +
                                       `<b>${getMarathiLabel('status')}:</b> ${statusText}`;
                        loanList.appendChild(li);
                    });
                    loanDetailsCell.appendChild(loanList);
                } else {
                    loanDetailsCell.textContent = getMarathiLabel('no_active_loans');
                }

                // Actions Cell
                const actionsCell = row.insertCell();
                const viewTransactionsBtn = document.createElement('button');
                viewTransactionsBtn.className = 'btn btn-secondary text-xs py-1 px-2 mb-1 mr-2';
                viewTransactionsBtn.textContent = getMarathiLabel('view_all_transactions');
                viewTransactionsBtn.onclick = () => viewTransactions(user.id, user.name);
                actionsCell.appendChild(viewTransactionsBtn);

                if (currentUserRole === 'admin') {
                    if (pendingContributions > 0) {
                        const markPaidBtn = document.createElement('button');
                        markPaidBtn.className = 'btn btn-success text-xs py-1 px-2 mb-1 mr-2';
                        markPaidBtn.textContent = getMarathiLabel('mark_paid');
                        // Find a pending cash contribution transaction for this user
                        const pendingCashTxn = userTransactions.find(t => t.type === 'contribution' && t.is_cash_payment && !t.is_paid);
                        if (pendingCashTxn) {
                            markPaidBtn.onclick = () => openMarkPaidModal(pendingCashTxn.id);
                            actionsCell.appendChild(markPaidBtn);
                        }
                    }
                    
                    activeLoans.forEach(loan => {
                        const repayLoanBtn = document.createElement('button');
                        repayLoanBtn.className = 'btn btn-primary text-xs py-1 px-2 mb-1 mr-2';
                        repayLoanBtn.textContent = getMarathiLabel('repay_loan');
                        repayLoanBtn.onclick = () => openRepayLoanModal(loan.id);
                        actionsCell.appendChild(repayLoanBtn);

                        const changeRateBtn = document.createElement('button');
                        changeRateBtn.className = 'btn btn-info text-xs py-1 px-2 mb-1 mr-2';
                        changeRateBtn.textContent = getMarathiLabel('change_interest_rate');
                        changeRateBtn.onclick = () => openChangeInterestRateModal(loan.id);
                        actionsCell.appendChild(changeRateBtn);
                    });

                    const deleteUserBtn = document.createElement('button');
                    deleteUserBtn.className = 'btn btn-danger text-xs py-1 px-2 mb-1';
                    deleteUserBtn.textContent = getMarathiLabel('delete');
                    deleteUserBtn.onclick = () => {
                        // IMPORTANT: Using confirm() for simplicity as per user request to not change UI.
                        // In a real app, replace with a custom modal for better UX.
                        if (confirm(getMarathiLabel('are_you_sure_delete_user'))) {
                            deleteUser(user.id, user.name);
                        }
                    };
                    actionsCell.appendChild(deleteUserBtn);
                }
            }

            // Populate user select dropdowns for modals
            groupUsers.forEach(user => {
                const optionContribution = document.createElement('option');
                optionContribution.value = user.id;
                optionContribution.textContent = user.name;
                userSelectContribution.appendChild(optionContribution);

                const optionLoan = document.createElement('option');
                optionLoan.value = user.id;
                optionLoan.textContent = user.name;
                userSelectLoan.appendChild(optionLoan);
            });
        }

        async function toggleUserStatus(userId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            try {
                const user = userData.find(u => u.id === userId);
                if (!user) {
                    flashMessage(getMarathiLabel('user_not_found'), 'danger');
                    return;
                }
                const newStatus = user.status === 'active' ? 'inactive' : 'active';
                await updateData('users', user.id, { status: newStatus }); // Pass user.id explicitly
                flashMessage(getMarathiLabel('user_status_changed', { status: newStatus }), 'success');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard to reflect changes
            } catch (error) {
                console.error("Error toggling user status:", error);
                flashMessage(getMarathiLabel('error_updating_data', { error: error.message }), 'danger');
            }
        }

        async function deleteUser(userId, userName) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            // Confirmation is handled by the calling button's onclick
            try {
                // Delete user's transactions
                const userTransactionsToDelete = transactionData.filter(t => t.user_id === userId);
                for (const t of userTransactionsToDelete) {
                    await deleteData('transactions', t.id);
                }
                // Delete user's loans
                const userLoansToDelete = loanData.filter(l => l.user_id === userId);
                for (const l of userLoansToDelete) {
                    await deleteData('loans', l.id);
                }
                // Delete the user
                await deleteData('users', userId);
                flashMessage(getMarathiLabel('user_deleted_success', { name: userName }), 'success');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            } catch (error) {
                console.error("Error deleting user:", error);
                flashMessage(getMarathiLabel('error_deleting_user', { error: error.message }), 'danger');
            }
        }

        async function deleteGroup(groupId, groupName) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            // Confirmation is handled by the calling button's onclick
            try {
                const usersInGroup = userData.filter(u => u.group_id === groupId);
                for (const user of usersInGroup) {
                    await deleteUser(user.id, user.name); // This will also delete their transactions and loans
                }
                await deleteData('groups', groupId);
                flashMessage(getMarathiLabel('group_deleted_success', { name: groupName }), 'success');
                selectedGroupId = null; // Clear selected group
                localStorage.removeItem('selectedGroupId'); // Also remove from local storage
                await populateGroupSelect(); // Reload group select
                document.getElementById('dashboard-content').style.display = 'none'; // Hide dashboard
                document.getElementById('all-groups-report-content').style.display = 'none';
            } catch (error) {
                console.error("Error deleting group:", error);
                flashMessage(getMarathiLabel('error_deleting_group', { error: error.message }), 'danger');
            }
        }


        // Add Group Form
        document.getElementById('add-group-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }

            const groupName = document.getElementById('group_name').value;
            const bankAccountDetails = document.getElementById('bank_account_details').value;
            const defaultInterestRate = parseFloat(document.getElementById('default_interest_rate').value);
            const bankInterestRate = parseFloat(document.getElementById('bank_interest_rate').value);

            if (isNaN(defaultInterestRate) || defaultInterestRate < 0 || defaultInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_range_error'), 'danger');
                return;
            }
            if (isNaN(bankInterestRate) || bankInterestRate < 0 || bankInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_range_error'), 'danger');
                return;
            }
            
            // Check if group already exists in current in-memory data
            if (groupData.some(g => g.name === groupName)) {
                flashMessage(getMarathiLabel('group_exists_error'), 'danger');
                return;
            }

            const newGroup = {
                id: generateUniqueId(), // Manual ID generation
                name: groupName,
                bank_account_details: bankAccountDetails,
                default_interest_rate: defaultInterestRate,
                bank_interest_rate: bankInterestRate,
                created_date: new Date().toISOString().slice(0, 10)
            };

            try {
                await addData('groups', newGroup);
                flashMessage(getMarathiLabel('group_added_success'), 'success');
                document.getElementById('add-group-form').reset();
                closeModal('addGroupModal');
                await populateGroupSelect(); // Reload group dropdown
            } catch (error) {
                console.error("Error adding group:", error);
                flashMessage(getMarathiLabel('error_adding_group', { error: error.message }), 'danger');
            }
        });

        // Add User Form
        document.getElementById('add-user-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }

            const userName = document.getElementById('user_name_input').value;
            const isAdmin = document.getElementById('is_admin').checked;

            // Check if user already exists in this group in current in-memory data
            if (userData.some(u => u.name === userName && u.group_id === selectedGroupId)) {
                flashMessage(getMarathiLabel('user_exists_in_group', { user_name: userName, target_group_id: selectedGroupId }), 'danger');
                return;
            }

            const newUser = {
                id: generateUniqueId(), // Manual ID generation
                name: userName,
                group_id: selectedGroupId,
                is_admin: isAdmin,
                status: 'active', // Default status
                created_date: new Date().toISOString().slice(0, 10)
            };

            try {
                await addData('users', newUser);
                flashMessage(getMarathiLabel('user_added_success', { name: userName }), 'success');
                document.getElementById('add-user-form').reset();
                closeModal('addUserModal');
                await loadGroupDashboard(selectedGroupId); // Reload users table
            } catch (error) {
                console.error("Error adding user:", error);
                flashMessage(getMarathiLabel('error_adding_user', { error: error.message }), 'danger');
            }
        });

        // Add Contribution Form
        document.getElementById('add-contribution-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }

            const userId = document.getElementById('user_id_contribution').value;
            const amount = parseFloat(document.getElementById('amount_contribution').value);
            const isCashPayment = document.getElementById('is_cash_payment_contribution').checked;

            if (isNaN(amount) || amount <= 0) {
                flashMessage(getMarathiLabel('repayment_amount_positive_error'), 'danger');
                return;
            }

            const user = userData.find(u => u.id === userId && u.group_id === selectedGroupId);
            if (!user) {
                flashMessage(getMarathiLabel('invalid_user_or_group'), 'danger');
                return;
            }

            const transactionStatus = isCashPayment ? 'pending_cash_payment' : 'paid_upi_bank';

            const newTransaction = {
                id: generateUniqueId(),
                user_id: userId,
                group_id: selectedGroupId,
                type: 'contribution',
                amount: amount,
                date: new Date().toISOString().slice(0, 10),
                is_cash_payment: isCashPayment,
                is_paid: !isCashPayment, // If cash, initially not paid; if not cash, it's paid
                description: `Contribution by ${user.name}`,
                loan_id: null,
                interest_paid_amount: null
            };

            try {
                await addData('transactions', newTransaction);
                flashMessage(getMarathiLabel('contribution_added_success', { amount: amount, user_name: user.name, status: getMarathiLabel(transactionStatus) }), 'success');
                document.getElementById('add-contribution-form').reset();
                closeModal('addContributionModal');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard to update summaries
            } catch (error) {
                console.error("Error adding contribution:", error);
                flashMessage(getMarathiLabel('error_adding_contribution', { error: error.message }), 'danger');
            }
        });

        // Populate user dropdown for Add Contribution and Add Loan
        // These event listeners should be on modal open, not DOMContentLoaded
        document.getElementById('addContributionModal').addEventListener('transitionend', async function(event) {
            if (event.propertyName === 'display' && this.style.display === 'block') { // Check if modal is now visible
                const userIdContributionSelect = document.getElementById('user_id_contribution');
                userIdContributionSelect.innerHTML = '';
                const groupUsers = userData.filter(u => u.group_id === selectedGroupId);
                groupUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userIdContributionSelect.appendChild(option);
                });
            }
        });

        document.getElementById('addLoanModal').addEventListener('transitionend', async function(event) {
            if (event.propertyName === 'display' && this.style.display === 'block') { // Check if modal is now visible
                const userIdLoanSelect = document.getElementById('user_id_loan');
                userIdLoanSelect.innerHTML = '';
                const groupUsers = userData.filter(u => u.group_id === selectedGroupId);
                groupUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    userIdLoanSelect.appendChild(option);
                });
            }
        });


        // Mark Paid Transaction
        function openMarkPaidModal(transactionId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            document.getElementById('mark-paid-transaction-id').value = transactionId;
            document.getElementById('mark-paid-confirmation-text').textContent = getMarathiLabel('mark_paid_confirmation_text');
            openModal('markPaidModal');
        }

        document.getElementById('markPaidForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const transactionId = document.getElementById('mark-paid-transaction-id').value;

            try {
                const transaction = transactionData.find(t => t.id === transactionId);
                if (!transaction || transaction.is_paid === true) {
                    flashMessage(getMarathiLabel('payment_already_paid'), 'danger');
                    return;
                }

                await updateData('transactions', transaction.id, { is_paid: true }); // Pass transaction.id explicitly
                flashMessage(getMarathiLabel('cash_payment_marked_paid'), 'success');
                closeModal('markPaidModal');
                await loadGroupDashboard(selectedGroupId);
                // If on transactions page, re-render it
                if (document.getElementById('view-transactions-content').style.display === 'block' && currentUserId) {
                     await renderTransactionsTable(currentUserId, document.getElementById('filter-from-date').value, document.getElementById('filter-to-date').value);
                }
            } catch (error) {
                console.error("Error marking transaction paid:", error);
                flashMessage(getMarathiLabel('error_updating_data', { error: error.message }), 'danger');
            }
        });


        // Add Loan Form
        document.getElementById('add-loan-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }

            const userId = document.getElementById('user_id_loan').value;
            const loanAmount = parseFloat(document.getElementById('loan_amount').value);
            const loanIssueDate = document.getElementById('loan_issue_date').value;
            const loanInterestRate = parseFloat(document.getElementById('loan_interest_rate').value);

            if (isNaN(loanAmount) || loanAmount <= 0) {
                flashMessage(getMarathiLabel('loan_amount_positive_error'), 'danger');
                return;
            }
            if (isNaN(loanInterestRate) || loanInterestRate < 0 || loanInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_range_error'), 'danger');
                return;
            }

            const user = userData.find(u => u.id === userId && u.group_id === selectedGroupId);
            if (!user) {
                flashMessage(getMarathiLabel('invalid_user_or_group'), 'danger');
                return;
            }

            const newLoan = {
                id: generateUniqueId(),
                user_id: userId,
                group_id: selectedGroupId,
                original_amount: loanAmount,
                outstanding_balance: loanAmount,
                interest_rate: loanInterestRate,
                issue_date: loanIssueDate,
                last_interest_calc_date: loanIssueDate, // Initially same as issue date
                status: 'active'
            };

            const loanTransaction = {
                id: generateUniqueId(),
                user_id: userId,
                group_id: selectedGroupId,
                type: 'loan_disbursement',
                amount: loanAmount,
                date: loanIssueDate,
                is_cash_payment: false, // Loan disbursement is typically not a cash payment to be marked paid
                is_paid: true, // It's paid out by the group
                description: `Loan disbursed to ${user.name}`,
                loan_id: newLoan.id,
                interest_paid_amount: null
            };

            try {
                await addData('loans', newLoan);
                await addData('transactions', loanTransaction);
                flashMessage(getMarathiLabel('loan_disbursed_success', { loan_id: newLoan.id, amount: loanAmount, user_name: user.name, rate: loanInterestRate }), 'success');
                document.getElementById('add-loan-form').reset();
                closeModal('addLoanModal');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            } catch (error) {
                console.error("Error adding loan:", error);
                flashMessage(getMarathiLabel('error_adding_loan', { error: error.message }), 'danger');
            }
        });

        // Repay Loan Modal
        function openRepayLoanModal(loanId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            const loan = loanData.find(l => l.id === loanId);
            if (!loan) {
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }
            if (loan.status === 'paid_off') {
                flashMessage(getMarathiLabel('loan_already_paid_off'), 'info');
                return;
            }

            document.getElementById('repay_loan_id').value = loanId;
            document.getElementById('display_repay_loan_id').textContent = loanId;
            document.getElementById('display_outstanding_balance').textContent = parseFloat(loan.outstanding_balance).toFixed(2);
            document.getElementById('display_current_interest_rate').textContent = parseFloat(loan.interest_rate).toFixed(2);
            document.getElementById('display_last_interest_calc_date').textContent = formatDate(loan.last_interest_calc_date || loan.issue_date);
            openModal('repayLoanModal');
        }

        document.getElementById('repay-loan-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const loanId = document.getElementById('repay_loan_id').value;
            const repaymentAmount = parseFloat(document.getElementById('repayment_amount').value);

            if (isNaN(repaymentAmount) || repaymentAmount <= 0) {
                flashMessage(getMarathiLabel('repayment_amount_positive_error'), 'danger');
                return;
            }

            try {
                const loan = loanData.find(l => l.id === loanId);
                if (!loan || loan.status === 'paid_off') {
                    flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                    return;
                }

                // Calculate interest accrued since last calculation date
                const interestAccrued = calculateInterest(parseFloat(loan.outstanding_balance), parseFloat(loan.interest_rate), loan.last_interest_calc_date);

                let actualPrincipalRepaid = 0;
                let interestPaidAmount = 0;
                let newOutstandingBalance = parseFloat(loan.outstanding_balance);

                if (repaymentAmount >= interestAccrued) {
                    interestPaidAmount = interestAccrued;
                    actualPrincipalRepaid = repaymentAmount - interestAccrued;
                    newOutstandingBalance -= actualPrincipalRepaid;
                } else {
                    interestPaidAmount = repaymentAmount;
                    actualPrincipalRepaid = 0;
                }

                let newLoanStatus = 'active';
                if (newOutstandingBalance <= 0) {
                    newOutstandingBalance = 0;
                    newLoanStatus = 'paid_off';
                }

                const updatedLoan = {
                    ...loan, // Keep existing properties
                    outstanding_balance: newOutstandingBalance,
                    last_interest_calc_date: new Date().toISOString().slice(0, 10), // Update last interest calc date
                    status: newLoanStatus
                };

                await updateData('loans', loan.id, updatedLoan); // Pass loan.id explicitly

                const repaymentTransaction = {
                    id: generateUniqueId(),
                    user_id: loan.user_id,
                    group_id: loan.group_id,
                    type: 'loan_repayment',
                    amount: repaymentAmount,
                    date: new Date().toISOString().slice(0, 10),
                    is_cash_payment: false, // Assume not cash for repayment form, adjust if needed
                    is_paid: true,
                    description: `Loan repayment for loan ${loanId}`,
                    loan_id: loanId,
                    interest_paid_amount: interestPaidAmount
                };
                await addData('transactions', repaymentTransaction);

                // Update group profit if interest was paid
                if (interestPaidAmount > 0) {
                    const group = groupData.find(g => g.id === loan.group_id);
                    if (group) {
                        const updatedGroup = {
                            ...group,
                            total_interest_received: (parseFloat(group.total_interest_received || 0) + interestPaidAmount).toFixed(2)
                        };
                        await updateData('groups', group.id, updatedGroup);
                    }
                }

                flashMessage(getMarathiLabel('loan_repayment_processed_success', {
                    repayment_amount: repaymentAmount.toFixed(2),
                    loan_id: loanId,
                    actual_principal_repaid: actualPrincipalRepaid.toFixed(2),
                    interest_paid_amount: interestPaidAmount.toFixed(2),
                    new_outstanding_balance: newOutstandingBalance.toFixed(2)
                }), 'success');

                if (newLoanStatus === 'paid_off') {
                    flashMessage(getMarathiLabel('loan_fully_paid_off', { loan_id: loanId }), 'success');
                }

                document.getElementById('repay-loan-form').reset();
                closeModal('repayLoanModal');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            } catch (error) {
                console.error("Error repaying loan:", error);
                flashMessage(getMarathiLabel('error_repaying_loan', { error: error.message }), 'danger');
            }
        });

        // Change Loan Interest Rate Modal
        function openChangeInterestRateModal(loanId) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            const loan = loanData.find(l => l.id === loanId);
            if (!loan) {
                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                return;
            }
            document.getElementById('change_rate_loan_id').value = loanId;
            document.getElementById('display_change_rate_loan_id').textContent = loanId;
            document.getElementById('display_old_interest_rate').textContent = parseFloat(loan.interest_rate).toFixed(2);
            document.getElementById('new_interest_rate_input').value = parseFloat(loan.interest_rate).toFixed(2); // Pre-fill with current rate
            openModal('changeInterestRateModal');
        }

        document.getElementById('change-interest-rate-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const loanId = document.getElementById('change_rate_loan_id').value;
            const newInterestRate = parseFloat(document.getElementById('new_interest_rate_input').value);

            if (isNaN(newInterestRate) || newInterestRate < 0 || newInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_range_error'), 'danger');
                return;
            }

            try {
                const loan = loanData.find(l => l.id === loanId);
                if (!loan) {
                    flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                    return;
                }
                const oldRate = loan.interest_rate;
                await updateData('loans', loan.id, { interest_rate: newInterestRate }); // Pass loan.id explicitly
                flashMessage(getMarathiLabel('loan_rate_changed_success', { loan_id: loanId, old_rate: oldRate, new_rate: newInterestRate }), 'success');
                closeModal('changeInterestRateModal');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            } catch (error) {
                console.error("Error changing loan interest rate:", error);
                flashMessage(getMarathiLabel('error_changing_loan_rate', { error: error.message }), 'danger');
            }
        });

        // Update Bank Interest Rate Modal
        function openUpdateBankRateModal(groupId, currentRate) {
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            document.getElementById('new_bank_interest_rate_input_2').value = parseFloat(currentRate).toFixed(2);
            openModal('updateBankRateModal');
            document.getElementById('update-bank-rate-form-2').dataset.groupId = groupId; // Store group ID
        }

        document.getElementById('update-bank-rate-form-2').addEventListener('submit', async function(event) {
            event.preventDefault();
            const groupId = this.dataset.groupId;
            const newBankInterestRate = parseFloat(document.getElementById('new_bank_interest_rate_input_2').value);

            if (isNaN(newBankInterestRate) || newBankInterestRate < 0 || newBankInterestRate > 100) {
                flashMessage(getMarathiLabel('interest_rate_range_error'), 'danger');
                return;
            }

            try {
                const group = groupData.find(g => g.id === groupId);
                if (!group) {
                    flashMessage(getMarathiLabel('group_not_found', { group_identifier: groupId }), 'danger');
                    return;
                }
                await updateData('groups', group.id, { bank_interest_rate: newBankInterestRate }); // Pass group.id explicitly
                flashMessage(getMarathiLabel('bank_interest_rate_updated_success'), 'success');
                closeModal('updateBankRateModal');
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            } catch (error) {
                console.error("Error updating bank interest rate:", error);
                flashMessage(getMarathiLabel('error_updating_bank_interest_rate', { error: error.message }), 'danger');
            }
        });


        // Calculate simple interest
        function calculateInterest(principal, annualRate, startDate) {
            const start = new Date(startDate);
            const end = new Date(); // Current date
            const diffTime = Math.abs(end.getTime() - start.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const interest = principal * (annualRate / 100) * (diffDays / 365);
            return parseFloat(interest.toFixed(2));
        }

        // Calculate Bank Interest (simplified)
        function calculateBankInterest(totalCorpus, annualRate) {
            // This is a very simplified calculation, assuming annual accrual for the current year
            // In a real scenario, this would be based on average daily balance or compounding periods.
            return totalCorpus * (annualRate / 100);
        }

        // Format Date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('mr-IN', options);
        }

        // View Transactions
        async function viewTransactions(userId, userName) {
            currentUserId = userId; // Set global currentUserId
            document.getElementById('view-transactions-user-name').textContent = userName;
            document.getElementById('view-transactions-header').textContent = getMarathiLabel('all_transactions_for', { user_name: userName });
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'block';
            await renderTransactionsTable(userId);
        }

        async function renderTransactionsTable(userId, fromDate = null, toDate = null) {
            const transactionsTbody = document.getElementById('transactions-data-tbody');
            transactionsTbody.innerHTML = '';
            document.getElementById('no-transactions-found').style.display = 'none';

            // Ensure latest data is used
            await loadInitialData(); 

            let filteredTransactions = transactionData.filter(t => t.user_id === userId);

            if (fromDate && toDate) {
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const filterFrom = new Date(fromDate);
                    const filterTo = new Date(toDate);
                    return transactionDate >= filterFrom && transactionDate <= filterTo;
                });
            }

            if (filteredTransactions.length === 0) {
                document.getElementById('no-transactions-found').style.display = 'block';
                document.getElementById('no-transactions-found').textContent = getMarathiLabel('no_transactions_found');
                return;
            }

            document.getElementById('date-th').textContent = getMarathiLabel('date');
            document.getElementById('type-th').textContent = getMarathiLabel('type');
            document.getElementById('amount-th').textContent = getMarathiLabel('amount');
            document.getElementById('is-cash-payment-th').textContent = getMarathiLabel('is_cash_payment');
            document.getElementById('is-paid-th').textContent = getMarathiLabel('is_paid');
            document.getElementById('loan-id-th').textContent = getMarathiLabel('loan_id');
            document.getElementById('new-loan-interest-rate-th').textContent = getMarathiLabel('new_loan_interest_rate'); // Used for new loan entries
            document.getElementById('description-th').textContent = getMarathiLabel('description');


            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

            filteredTransactions.forEach(transaction => {
                const row = transactionsTbody.insertRow();
                row.insertCell().textContent = formatDate(transaction.date);
                row.insertCell().textContent = getMarathiLabel(transaction.type);
                row.insertCell().textContent = parseFloat(transaction.amount).toFixed(2);
                row.insertCell().textContent = transaction.is_cash_payment ? getMarathiLabel('yes') : getMarathiLabel('no');
                
                const isPaidCell = row.insertCell();
                if (transaction.is_paid !== undefined) {
                    isPaidCell.textContent = transaction.is_paid ? getMarathiLabel('yes') : getMarathiLabel('no');
                    isPaidCell.classList.add(transaction.is_paid ? 'status-paid' : 'status-pending');
                } else {
                    isPaidCell.textContent = getMarathiLabel('status_not_applicable');
                    isPaidCell.classList.add('status-not-applicable');
                }
                
                row.insertCell().textContent = transaction.loan_id || getMarathiLabel('status_not_applicable'); // Display loan ID if applicable
                row.insertCell().textContent = transaction.type === 'loan_disbursement' && transaction.loan_id ? 
                                                 loanData.find(l => l.id === transaction.loan_id)?.interest_rate + '%' || getMarathiLabel('status_not_applicable') : 
                                                 getMarathiLabel('status_not_applicable'); // Display loan interest rate
                row.insertCell().textContent = transaction.description || '';

                // Add actions (e.g., mark paid for pending cash payments)
                const actionsCell = row.insertCell();
                if (currentUserRole === 'admin' && transaction.type === 'contribution' && transaction.is_cash_payment && !transaction.is_paid) {
                    const markPaidBtn = document.createElement('button');
                    markPaidBtn.className = 'btn btn-primary btn-sm';
                    markPaidBtn.textContent = getMarathiLabel('mark_paid');
                    markPaidBtn.onclick = () => openMarkPaidModal(transaction.id);
                    actionsCell.appendChild(markPaidBtn);
                } else if (currentUserRole === 'admin' && transaction.type === 'loan_disbursement' && transaction.loan_id) {
                    const repayLoanBtn = document.createElement('button');
                    repayLoanBtn.className = 'btn btn-primary btn-sm mr-2';
                    repayLoanBtn.textContent = getMarathiLabel('repay_loan');
                    repayLoanBtn.onclick = () => openRepayLoanModal(transaction.loan_id);
                    actionsCell.appendChild(repayLoanBtn);

                    const changeRateBtn = document.createElement('button');
                    changeRateBtn.className = 'btn btn-info btn-sm';
                    changeRateBtn.textContent = getMarathiLabel('change_interest_rate');
                    changeRateBtn.onclick = () => openChangeInterestRateModal(transaction.loan_id);
                    actionsCell.appendChild(changeRateBtn);
                }
            });
        }

        document.getElementById('filter-transactions-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const fromDate = document.getElementById('filter-from-date').value;
            const toDate = document.getElementById('filter-to-date').value;
            await renderTransactionsTable(currentUserId, fromDate, toDate);
        });

        function clearTransactionFilter() {
            document.getElementById('filter-from-date').value = '';
            document.getElementById('filter-to-date').value = '';
            renderTransactionsTable(currentUserId);
        }

        function showDashboard() {
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('all-groups-report-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'none';
            if (selectedGroupId) {
                loadGroupDashboard(selectedGroupId); // Reload dashboard to ensure latest data
            }
        }

        async function showAllGroupsReport() {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('view-transactions-content').style.display = 'none';
            document.getElementById('all-groups-report-content').style.display = 'block';
            await renderAllGroupsReport();
        }

        async function renderAllGroupsReport() {
            const reportCardsDiv = document.getElementById('all-groups-report-cards');
            reportCardsDiv.innerHTML = '';
            
            // Ensure latest data
            await loadInitialData(); 

            if (groupData.length === 0) {
                reportCardsDiv.innerHTML = `<p>${getMarathiLabel('no_groups_found_to_generate_report')}</p>`;
                return;
            }

            for (const group of groupData) {
                const card = document.createElement('div');
                card.className = 'card mb-6';

                const groupUsers = userData.filter(u => u.group_id === group.id);
                const groupTransactions = transactionData.filter(t => groupUsers.some(u => u.id === t.user_id));
                const groupLoans = loanData.filter(l => groupUsers.some(u => u.id === l.user_id));

                const totalContributions = groupTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                const totalOutstandingLoans = groupLoans.reduce((sum, loan) => {
                    if (loan.status === 'active') {
                        const calculatedInterest = calculateInterest(parseFloat(loan.outstanding_balance), parseFloat(loan.interest_rate), loan.last_interest_calc_date || loan.issue_date);
                        return sum + parseFloat(loan.outstanding_balance) + calculatedInterest;
                    }
                    return sum;
                }, 0);

                const totalPaidContributions = groupTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const totalInterestReceived = groupTransactions
                    .filter(t => t.type === 'interest_paid')
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                const bankInterestEarned = group.bank_interest_rate ? calculateBankInterest(totalContributions, group.bank_interest_rate) : 0;
                
                const netProfit = (totalPaidContributions + totalInterestReceived + bankInterestEarned) - 
                                  groupTransactions.filter(t => t.type === 'loan_disbursement').reduce((sum,t)=>sum+parseFloat(t.amount),0);

                card.innerHTML = `
                    <h2 class="text-xl font-semibold mb-4">${getMarathiLabel('group_name_report')}: ${group.name}</h2>
                    <p><b>${getMarathiLabel('bank_account_details')}:</b> ${group.bank_account_details || 'N/A'}</p>
                    <p><b>${getMarathiLabel('default_interest_rate')}:</b> ${parseFloat(group.default_interest_rate).toFixed(2)}%</p>
                    <p><b>${getMarathiLabel('bank_interest_rate')}:</b> ${parseFloat(group.bank_interest_rate).toFixed(2)}%</p>
                    <div class="report-grid mt-4">
                        <div class="report-widget profit">
                            <h3 class="text-lg font-semibold">${getMarathiLabel('total_contributions')}</h3>
                            <p class="text-3xl font-bold">₹${totalContributions.toFixed(2)}</p>
                        </div>
                        <div class="report-widget loan">
                            <h3 class="text-lg font-semibold">${getMarathiLabel('total_outstanding_loans_report')}</h3>
                            <p class="text-3xl font-bold">₹${totalOutstandingLoans.toFixed(2)}</p>
                        </div>
                         <div class="report-widget profit">
                            <h3 class="text-lg font-semibold">${getMarathiLabel('total_interest_received')}</h3>
                            <p class="text-3xl font-bold">₹${totalInterestReceived.toFixed(2)}</p>
                        </div>
                        <div class="report-widget profit">
                            <h3 class="text-lg font-semibold">${getMarathiLabel('total_bank_interest_report')}</h3>
                            <p class="text-3xl font-bold">₹${bankInterestEarned.toFixed(2)}</p>
                        </div>
                        <div class="report-widget profit">
                            <h3 class="text-lg font-semibold">${getMarathiLabel('net_profit_report')}</h3>
                            <p class="text-3xl font-bold">₹${netProfit.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                 if (currentUserRole === 'admin') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger mt-4';
                    deleteBtn.textContent = getMarathiLabel('delete');
                    deleteBtn.onclick = () => {
                        // IMPORTANT: Using confirm() for simplicity as per user request to not change UI.
                        // In a real app, replace with a custom modal for better UX.
                        if (confirm(getMarathiLabel('are_you_sure_delete_group'))) {
                            deleteGroup(group.id, group.name);
                        }
                    };
                    card.appendChild(deleteBtn);
                }
                reportCardsDiv.appendChild(card);
            }
        }

        // CSV Uploads
        document.getElementById('bulk-upload-transactions-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }

            const fileInput = document.getElementById('transaction_csv');
            const file = fileInput.files[0];

            if (!file) {
                flashMessage(getMarathiLabel('csv_upload_failed_no_file'), 'danger');
                return;
            }
            if (file.type !== 'text/csv') {
                flashMessage(getMarathiLabel('csv_upload_failed_invalid_type'), 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    flashMessage('CSV file is empty.', 'danger');
                    return;
                }
                const headers = lines[0].split(',').map(h => h.trim());
                let processedCount = 0;
                let errorCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length !== headers.length) {
                        console.warn(`Skipping row ${i+1}: Mismatched column count.`);
                        errorCount++;
                        continue;
                    }

                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = values[index];
                    });

                    try {
                        const userName = rowData['user_name'];
                        const type = rowData['type'];
                        const amount = parseFloat(rowData['amount']);
                        const date = rowData['date'];
                        const isCashPayment = rowData['is_cash_payment'] === 'TRUE';
                        const loanId = rowData['loan_id'] || null; // For loan repayments
                        const description = rowData['description'] || '';
                        const newLoanInterestRate = rowData['new_loan_interest_rate'] ? parseFloat(rowData['new_loan_interest_rate']) : null;


                        const user = userData.find(u => u.name === userName && u.group_id === selectedGroupId);
                        if (!user) {
                            flashMessage(getMarathiLabel('user_not_found_in_group', { user_name: userName, group_name: groupData.find(g => g.id === selectedGroupId)?.name || '' }), 'danger');
                            errorCount++;
                            continue;
                        }

                        if (isNaN(amount) || amount <= 0) {
                            flashMessage(getMarathiLabel('data_conversion_error', { error: `Invalid amount for row ${i+1}` }), 'danger');
                            errorCount++;
                            continue;
                        }

                        let newTransaction;
                        if (type === 'contribution') {
                            newTransaction = {
                                id: generateUniqueId(),
                                user_id: user.id,
                                group_id: selectedGroupId,
                                type: 'contribution',
                                amount: amount,
                                date: date,
                                is_cash_payment: isCashPayment,
                                is_paid: !isCashPayment,
                                description: description,
                                loan_id: null,
                                interest_paid_amount: null
                            };
                            await addData('transactions', newTransaction);
                        } else if (type === 'loan_repayment') {
                            if (!loanId) {
                                flashMessage(getMarathiLabel('loan_id_missing'), 'danger');
                                errorCount++;
                                continue;
                            }
                            const loan = loanData.find(l => l.id === loanId && l.user_id === user.id && l.group_id === selectedGroupId);
                            if (!loan || loan.status === 'paid_off') {
                                flashMessage(getMarathiLabel('loan_not_found', { loan_id: loanId }), 'danger');
                                errorCount++;
                                continue;
                            }

                            // Re-use existing repayment logic for calculations
                            const interestAccrued = calculateInterest(parseFloat(loan.outstanding_balance), parseFloat(loan.interest_rate), loan.last_interest_calc_date);
                            let actualPrincipalRepaid = 0;
                            let interestPaidAmount = 0;
                            let newOutstandingBalance = parseFloat(loan.outstanding_balance);

                            if (amount >= interestAccrued) {
                                interestPaidAmount = interestAccrued;
                                actualPrincipalRepaid = amount - interestAccrued;
                                newOutstandingBalance -= actualPrincipalRepaid;
                            } else {
                                interestPaidAmount = amount;
                                actualPrincipalRepaid = 0;
                            }

                            let newLoanStatus = 'active';
                            if (newOutstandingBalance <= 0) {
                                newOutstandingBalance = 0;
                                newLoanStatus = 'paid_off';
                            }

                            const updatedLoan = {
                                ...loan, // Keep existing properties
                                outstanding_balance: newOutstandingBalance,
                                last_interest_calc_date: date,
                                status: newLoanStatus
                            };
                            await updateData('loans', loan.id, updatedLoan);

                            newTransaction = {
                                id: generateUniqueId(),
                                user_id: user.id,
                                group_id: selectedGroupId,
                                type: 'loan_repayment',
                                amount: amount,
                                date: date,
                                is_cash_payment: isCashPayment,
                                is_paid: !isCashPayment,
                                description: description,
                                loan_id: loanId,
                                interest_paid_amount: interestPaidAmount
                            };
                            await addData('transactions', newTransaction);

                            if (newLoanStatus === 'paid_off') {
                                flashMessage(getMarathiLabel('loan_fully_paid_off', { loan_id: loanId }), 'success');
                            }

                        } else if (type === 'loan_disbursement') {
                             if (isNaN(newLoanInterestRate) || newLoanInterestRate < 0 || newLoanInterestRate > 100) {
                                flashMessage(getMarathiLabel('invalid_interest_rate', { rate: newLoanInterestRate }), 'danger');
                                errorCount++;
                                continue;
                            }

                            const newLoan = {
                                id: generateUniqueId(),
                                user_id: user.id,
                                group_id: selectedGroupId,
                                original_amount: amount,
                                outstanding_balance: amount,
                                interest_rate: newLoanInterestRate,
                                issue_date: date,
                                last_interest_calc_date: date,
                                status: 'active'
                            };
                            await addData('loans', newLoan);

                            newTransaction = {
                                id: generateUniqueId(),
                                user_id: user.id,
                                group_id: selectedGroupId,
                                type: 'loan_disbursement',
                                amount: amount,
                                date: date,
                                is_cash_payment: false,
                                is_paid: true,
                                description: description,
                                loan_id: newLoan.id,
                                interest_paid_amount: null
                            };
                            await addData('transactions', newTransaction);

                        } else {
                            flashMessage(getMarathiLabel('unknown_transaction_type', { transaction_type: type }), 'danger');
                            errorCount++;
                            continue;
                        }
                        processedCount++;
                    } catch (error) {
                        console.error(`Error processing transaction row ${i+1}:`, rowData, error);
                        flashMessage(getMarathiLabel('error_processing_row', { error: error.message }), 'danger');
                        errorCount++;
                    }
                }
                flashMessage(getMarathiLabel('upload_complete', { processed_count: processedCount, error_count: errorCount }), 'info');
                fileInput.value = ''; // Clear file input
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            };
            reader.readAsText(file);
        });

        document.getElementById('bulk-upload-users-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            if (currentUserRole !== 'admin') {
                flashMessage(getMarathiLabel('unauthorized_access'), 'danger');
                return;
            }
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }

            const fileInput = document.getElementById('user_csv');
            const file = fileInput.files[0];

            if (!file) {
                flashMessage(getMarathiLabel('csv_upload_failed_no_file'), 'danger');
                return;
            }
            if (file.type !== 'text/csv') {
                flashMessage(getMarathiLabel('csv_upload_failed_invalid_type'), 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    flashMessage('CSV file is empty.', 'danger');
                    return;
                }
                const headers = lines[0].split(',').map(h => h.trim());
                let processedCount = 0;
                let errorCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length !== headers.length) {
                        console.warn(`Skipping row ${i+1}: Mismatched column count.`);
                        errorCount++;
                        continue;
                    }

                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = values[index];
                    });

                    try {
                        const userName = rowData['user_name'];
                        const isAdmin = rowData['is_admin'] === 'TRUE';

                        // Check if user already exists in this group in current in-memory data
                        if (userData.some(u => u.name === userName && u.group_id === selectedGroupId)) {
                            flashMessage(getMarathiLabel('user_exists_in_group', { row_num: i + 1, user_name: userName, target_group_id: selectedGroupId }), 'danger');
                            errorCount++;
                            continue;
                        }

                        const newUser = {
                            id: generateUniqueId(),
                            name: userName,
                            group_id: selectedGroupId,
                            is_admin: isAdmin,
                            status: 'active',
                            created_date: new Date().toISOString().slice(0, 10)
                        };
                        await addData('users', newUser);
                        processedCount++;
                    } catch (error) {
                        console.error(`Error processing user row ${i+1}:`, rowData, error);
                        flashMessage(getMarathiLabel('error_processing_row', { error: error.message }), 'danger');
                        errorCount++;
                    }
                }
                flashMessage(getMarathiLabel('upload_complete', { processed_count: processedCount, error_count: errorCount }).replace('व्यवहार', 'सदस्य'), 'info'); // Localization hack for users
                fileInput.value = ''; // Clear file input
                await loadGroupDashboard(selectedGroupId); // Reload dashboard
            };
            reader.readAsText(file);
        });

        function downloadSampleTransactionsCsv() {
            const csvContent = `user_name,type,amount,date,is_cash_payment,loan_id,description,new_loan_interest_rate\n` +
                               `Sample User 1,contribution,500.00,${new Date().toISOString().slice(0, 10)},FALSE,,Monthly contribution,\n` +
                               `Sample User 2,loan_disbursement,10000.00,${new Date().toISOString().slice(0, 10)},FALSE,,Loan for medical emergency,10.0\n` +
                               `Sample User 3,loan_repayment,1200.00,${new Date().toISOString().slice(0, 10)},FALSE,loan_id_here,Partial repayment,\n`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'sample_transactions.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadSampleUsersCsv() {
            const csvContent = `user_name,is_admin\n` +
                               `New User A,FALSE\n` +
                               `New User B,TRUE\n`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'sample_users.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadUsersCsv() {
            if (!selectedGroupId) {
                flashMessage(getMarathiLabel('please_select_group'), 'danger');
                return;
            }
            const group = groupData.find(g => g.id === selectedGroupId);
            if (!group) {
                flashMessage(getMarathiLabel('group_not_found', { group_identifier: selectedGroupId }), 'danger');
                return;
            }

            const allUsers = await getAllData('users'); // Ensure latest users
            const groupUsers = allUsers.filter(u => u.group_id === selectedGroupId);

            let csvContent = `User Name,Is Admin,Status,Total Contribution,Pending Contribution,Total Loan Disbursed,Pending Loan Amount (with interest),Total Paid Till Date\n`;
            for (const user of groupUsers) {
                const isAdmin = user.is_admin ? getMarathiLabel('yes') : getMarathiLabel('no');
                const userTransactions = transactionData.filter(t => t.user_id === user.id);
                const userLoans = loanData.filter(l => l.user_id === user.id);

                const totalContributions = userTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                const pendingContributions = userTransactions
                    .filter(t => t.type === 'contribution' && t.is_paid === false)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                const totalLoanAmountDisbursedToUser = userTransactions
                    .filter(t => t.type === 'loan_disbursement')
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                let pendingLoanAmountWithInterest = 0;
                let totalAmountPaidByUserTillDate = 0;

                const activeLoans = userLoans.filter(loan => loan.status === 'active');
                for (const loan of activeLoans) {
                    const calculatedInterest = calculateInterest(parseFloat(loan.outstanding_balance), parseFloat(loan.interest_rate), loan.last_interest_calc_date || loan.issue_date);
                    pendingLoanAmountWithInterest += parseFloat(loan.outstanding_balance) + calculatedInterest;
                }

                totalAmountPaidByUserTillDate = totalContributions + userTransactions
                    .filter(t => t.type === 'loan_repayment' && t.is_paid === true)
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);

                csvContent += `${user.name},${isAdmin},${user.status},${totalContributions.toFixed(2)},${pendingContributions.toFixed(2)},${totalLoanAmountDisbursedToUser.toFixed(2)},${pendingLoanAmountWithInterest.toFixed(2)},${totalAmountPaidByUserTillDate.toFixed(2)}\n`;
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `${group.name}_users_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadTransactionsCsv() {
            if (!currentUserId) {
                flashMessage(getMarathiLabel('no_user_selected'), 'danger'); // Add this label to Marathi
                return;
            }
            const user = userData.find(u => u.id === currentUserId);
            if (!user) {
                flashMessage(getMarathiLabel('user_not_found'), 'danger');
                return;
            }
            const transactionsForUser = transactionData.filter(t => t.user_id === currentUserId);

            let csvContent = `Date,Type,Amount,Is Cash Payment,Is Paid,Loan ID,Interest Paid Amount,Description\n`;
            transactionsForUser.forEach(t => {
                const date = t.date;
                const type = t.type;
                const amount = parseFloat(t.amount).toFixed(2);
                const isCash = t.is_cash_payment ? 'TRUE' : 'FALSE';
                const isPaid = t.is_paid ? 'TRUE' : 'FALSE';
                const loanId = t.loan_id || '';
                const interestPaid = t.interest_paid_amount !== null ? parseFloat(t.interest_paid_amount).toFixed(2) : '';
                const description = t.description || '';
                csvContent += `${date},${type},${amount},${isCash},${isPaid},${loanId},${interestPaid},"${description}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `${user.name}_transactions_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // Initialize on page load (after DOM is ready)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('app-name-header').textContent = getMarathiLabel('app_name');
            document.getElementById('select-group-heading').textContent = getMarathiLabel('select_group');
            document.getElementById('add-group-btn').textContent = getMarathiLabel('add_group');
            document.getElementById('add-group-modal-heading').textContent = getMarathiLabel('add_group');
            document.getElementById('group-name-label').textContent = getMarathiLabel('group_name');
            document.getElementById('bank-account-details-label').textContent = getMarathiLabel('bank_account_details');
            document.getElementById('default-interest-rate-label').textContent = getMarathiLabel('default_interest_rate');
            document.getElementById('bank-interest-rate-label').textContent = getMarathiLabel('bank_interest_rate');
            document.getElementById('add-group-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('add-new-user-btn').textContent = getMarathiLabel('add_new_user');
            document.getElementById('add-new-user-modal-heading').textContent = getMarathiLabel('add_new_user');
            document.getElementById('user-name-input-label').textContent = getMarathiLabel('user_name_input');
            document.getElementById('is-admin-label').textContent = getMarathiLabel('is_admin');
            document.getElementById('add-user-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('add-contribution-btn').textContent = getMarathiLabel('add_contribution');
            document.getElementById('add-contribution-modal-heading').textContent = getMarathiLabel('add_contribution');
            document.getElementById('user-name-contribution-label').textContent = getMarathiLabel('user_name');
            document.getElementById('amount-label-contribution').textContent = getMarathiLabel('amount');
            document.getElementById('is-cash-payment-label-contribution').textContent = getMarathiLabel('is_cash_payment');
            document.getElementById('add-contribution-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('mark-paid-modal-heading').textContent = getMarathiLabel('mark_paid');
            document.getElementById('mark-paid-submit-btn').textContent = getMarathiLabel('mark_paid');
            document.getElementById('add-new-loan-btn').textContent = getMarathiLabel('add_new_loan');
            document.getElementById('add-new-loan-modal-heading').textContent = getMarathiLabel('add_new_loan');
            document.getElementById('user-name-loan-label').textContent = getMarathiLabel('user_name');
            document.getElementById('loan-amount-label').textContent = getMarathiLabel('loan_amount');
            document.getElementById('loan-issue-date-label').textContent = getMarathiLabel('loan_issue_date');
            document.getElementById('loan-interest-rate-label').textContent = getMarathiLabel('loan_interest_rate');
            document.getElementById('add-loan-submit-btn').textContent = getMarathiLabel('add');
            document.getElementById('repay-loan-modal-heading').textContent = getMarathiLabel('repay_loan');
            document.getElementById('loan-id-display-label').textContent = getMarathiLabel('loan_id_display');
            document.getElementById('outstanding-balance-display-label').textContent = getMarathiLabel('outstanding_balance_display');
            document.getElementById('current-interest-rate-display-label').textContent = getMarathiLabel('current_interest_rate_display');
            document.getElementById('last-interest-calc-date-display-label').textContent = getMarathiLabel('last_interest_calc_date_display');
            document.getElementById('repayment-amount-label').textContent = getMarathiLabel('repayment_amount_input');
            document.getElementById('repay-loan-submit-btn').textContent = getMarathiLabel('repay_loan');
            document.getElementById('change-interest-rate-modal-heading').textContent = getMarathiLabel('change_interest_rate');
            document.getElementById('loan-id-change-rate-label').textContent = getMarathiLabel('loan_id_display');
            document.getElementById('current-rate-change-rate-label').textContent = getMarathiLabel('current_rate_display');
            document.getElementById('new-interest-rate-input-label').textContent = getMarathiLabel('new_interest_rate_input');
            document.getElementById('change-interest-rate-submit-btn').textContent = getMarathiLabel('update');
            document.getElementById('bulk-upload-transactions-heading').textContent = getMarathiLabel('bulk_upload_transactions');
            document.getElementById('choose-csv-file-transactions-label').textContent = getMarathiLabel('choose_csv_file');
            document.getElementById('upload-transactions-btn').textContent = getMarathiLabel('upload');
            document.getElementById('download-sample-transactions-btn').textContent = getMarathiLabel('download_sample_transactions');
            document.getElementById('bulk-upload-users-heading').textContent = getMarathiLabel('bulk_upload_users');
            document.getElementById('choose-csv-file-users-label').textContent = getMarathiLabel('choose_csv_file');
            document.getElementById('upload-users-btn').textContent = getMarathiLabel('upload');
            document.getElementById('download-sample-users-btn').textContent = getMarathiLabel('download_sample_users');
            document.getElementById('download-users-csv-btn').textContent = getMarathiLabel('download_users_csv');
            document.getElementById('view-all-groups-report-btn').textContent = getMarathiLabel('view_all_groups_report');
            document.getElementById('back-to-dashboard-btn-report').textContent = getMarathiLabel('back_to_dashboard');
            document.getElementById('back-to-dashboard-btn-transactions').textContent = getMarathiLabel('back_to_dashboard');
            document.getElementById('filter-transactions-heading').textContent = getMarathiLabel('filter_transactions');
            document.getElementById('from-date-label').textContent = getMarathiLabel('from_date');
            document.getElementById('to-date-label').textContent = getMarathiLabel('to_date');
            document.getElementById('apply-filter-btn').textContent = getMarathiLabel('apply_filter');
            document.getElementById('clear-filter-btn').textContent = getMarathiLabel('clear_filter');
            document.getElementById('transaction-history-heading').textContent = getMarathiLabel('transaction_history');
            document.getElementById('download-transactions-csv-btn').textContent = getMarathiLabel('download_transactions_csv');
            document.getElementById('edit-bank-interest-rate-modal-heading').textContent = getMarathiLabel('edit_bank_interest_rate');
            document.getElementById('new-interest-rate-label').textContent = getMarathiLabel('new_interest_rate_label');
            document.getElementById('update-bank-rate-submit-btn').textContent = getMarathiLabel('update');
            document.getElementById('edit-bank-interest-rate-modal-heading-2').textContent = getMarathiLabel('edit_bank_interest_rate');
            document.getElementById('new-interest-rate-label-2').textContent = getMarathiLabel('new_interest_rate_label');
            document.getElementById('update-bank-rate-submit-btn-2').textContent = getMarathiLabel('update');


            // Initially show login modal
            document.getElementById('loginModal').style.display = 'block';
        });
    </script>
</body>
</html>
